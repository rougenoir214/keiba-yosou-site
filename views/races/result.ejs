<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ¬ãƒ¼ã‚¹çµæœ - <%= race.race_name %></title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); background-attachment: fixed; min-height: 100vh; padding: 20px; }
.container { max-width: 1200px; margin: 0 auto; }
.header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 30px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.3); }
.header h1 { color: #333; margin-bottom: 15px; font-size: 1.8rem; font-weight: 700; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.header p { color: #666; font-weight: 500; margin-top: 10px; }
.back-link { display: inline-block; margin-top: 10px; margin-right: 15px; color: #667eea; text-decoration: none; font-weight: 600; transition: all 0.3s; padding: 5px 10px; border-radius: 5px; }
.back-link:hover { background: rgba(102, 126, 234, 0.1); transform: translateX(-5px); }
.section { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 30px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 8px 30px rgba(0,0,0,0.12); border: 1px solid rgba(255,255,255,0.3); }
.section h2 { color: #333; margin-bottom: 20px; border-bottom: 3px solid transparent; border-image: linear-gradient(90deg, #667eea 0%, #764ba2 100%); border-image-slice: 1; padding-bottom: 12px; font-size: 1.5rem; font-weight: 700; }
table { width: 100%; border-collapse: collapse; }
th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 14px 12px; text-align: left; font-weight: 600; }
td { padding: 12px; border-bottom: 1px solid #eee; }
tr:hover { background: #f5f5f5; }
.rank-1 { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%) !important; font-weight: bold; }
.rank-2 { background: linear-gradient(135deg, #c0c0c0 0%, #e0e0e0 100%) !important; font-weight: bold; }
.rank-3 { background: linear-gradient(135deg, #cd7f32 0%, #e8a87c 100%) !important; font-weight: bold; }
tr.no-rank { opacity: 0.5; background: #f9f9f9; }
tr.no-rank td { color: #999; }
.payout-item { display: flex; justify-content: space-between; padding: 10px; background: #f5f5f5; margin-bottom: 5px; border-radius: 5px; }
.btn { padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
.btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6); }
.btn-success { background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4); }
.btn-success:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6); }

/* ã‚¹ãƒãƒ›å¯¾å¿œ */
@media (max-width: 768px) {
    body { padding: 10px; }
    .header, .section { padding: 15px; }
    .header h1 { font-size: 1.3rem; }
    .header p { font-size: 0.9rem; }
    .back-link { display: block; margin: 5px 0; }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ« */
    table { font-size: 0.75rem; display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; min-width: 100%; }
    th, td { padding: 6px 3px; white-space: normal !important; word-wrap: break-word; }
    
    /* ãƒœã‚¿ãƒ³ */
    .btn { width: 100%; margin: 5px 0; }
    
    /* é…å½“è¡¨ç¤º */
    .payout-item { flex-direction: column; gap: 5px; }
}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>ğŸ <%= race.race_name %> - ãƒ¬ãƒ¼ã‚¹çµæœ</h1>
<p>ğŸ“… <%= new Date(race.race_date).toLocaleDateString('ja-JP') %> | ğŸ“ <%= race.venue %></p>
<div style="margin-top: 15px;">
<button onclick="fetchResultFromNetkeiba()" class="btn" style="background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%); box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);">
ğŸŒ netkeibaã‹ã‚‰çµæœã‚’è‡ªå‹•å–å¾—
</button>
</div>
<a href="/races/<%= race.race_id %>" class="back-link">â† å‡ºé¦¬è¡¨ã«æˆ»ã‚‹</a>
<a href="/races" class="back-link">â† ãƒ¬ãƒ¼ã‚¹ä¸€è¦§</a>
</div>
<div class="section">
<h2>ğŸ† ç€é †</h2>
<% if (results.length === 0) { %>
<p style="color: #888;">ã¾ã çµæœãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
<% } else { %>
<% 
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—ï¼ˆäºˆæƒ³ã‚’å…¥åŠ›ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
const uniqueUsers = [...new Set(predictions.map(p => p.user_id))];
const userMap = {};
predictions.forEach(p => {
    if (!userMap[p.user_id]) {
        userMap[p.user_id] = p.display_name;
    }
});
%>
<table>
<thead>
<tr>
<th>ç€é †</th><th>é¦¬ç•ª</th><th>é¦¬å</th><th>é¨æ‰‹</th><th>ã‚¿ã‚¤ãƒ </th>
<% uniqueUsers.forEach(userId => { %>
    <th style="background: #667eea; color: white; font-weight: bold; min-width: 50px;"><%= userMap[userId] %></th>
<% }); %>
</tr>
</thead>
<tbody>
<% results.forEach(result => { %>
<%
// ç€é †ãŒã‚ã‚‹ã‹ã©ã†ã‹ã§è¡Œã®ã‚¯ãƒ©ã‚¹ã‚’å¤‰æ›´
let rowClass = '';
if (result.rank) {
    if (result.rank <= 3) {
        rowClass = `rank-${result.rank}`;
    }
} else {
    rowClass = 'no-rank';
}
%>
<tr class="<%= rowClass %>">
<td><strong><%= result.rank || '-' %></strong></td>
<td><strong><%= result.umaban %></strong></td>
<td><%= result.horse_name %></td>
<td><%= result.jockey %></td>
<td><%= result.result_time || '-' %></td>
<% uniqueUsers.forEach(userId => { %>
    <% 
    const userPred = predictions.find(p => p.umaban == result.umaban && p.user_id == userId);
    %>
    <td style="text-align: center; font-size: 18px;">
        <%= userPred ? userPred.mark : '-' %>
    </td>
<% }); %>
</tr>
<% }); %>
</tbody>
</table>
<% } %>
</div>
<div class="section">
<h2>ğŸ’° æ‰•æˆ»é‡‘</h2>
<% if (payouts.length === 0) { %>
<p style="color: #888;">ã¾ã æ‰•æˆ»é‡‘ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
<% } else { %>
<% const betTypeNames = { 'tansho': 'å˜å‹', 'fukusho': 'è¤‡å‹', 'umaren': 'é¦¬é€£', 'umatan': 'é¦¬å˜', 'wide': 'ãƒ¯ã‚¤ãƒ‰', 'sanrenpuku': '3é€£è¤‡', 'sanrentan': '3é€£å˜' }; %>
<% let currentType = ''; %>
<% payouts.forEach(payout => { %>
<% if (currentType !== payout.bet_type) { %>
<% if (currentType) { %></div><% } %>
<h3 style="margin-top: 15px; color: #667eea;"><%= betTypeNames[payout.bet_type] %></h3>
<div>
<% currentType = payout.bet_type; %>
<% } %>
<div class="payout-item">
<span><strong><%= payout.combination %></strong></span>
<span><%= payout.payout.toLocaleString() %>å††</span>
</div>
<% }); %>
<% if (currentType) { %></div><% } %>
<% } %>
</div>

<div class="section">
<h2>ğŸ« è³¼å…¥æ¸ˆã¿é¦¬åˆ¸ä¸€è¦§</h2>
<% if (allBets.length === 0) { %>
<p style="color: #888;">ã¾ã é¦¬åˆ¸ãŒè³¼å…¥ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
<% } else { %>
<% const betTypeNames = { 'tansho': 'å˜å‹', 'fukusho': 'è¤‡å‹', 'umaren': 'é¦¬é€£', 'umatan': 'é¦¬å˜', 'wide': 'ãƒ¯ã‚¤ãƒ‰', 'sanrenpuku': '3é€£è¤‡', 'sanrentan': '3é€£å˜' }; %>
<% const userBets = {}; %>
<% allBets.forEach(bet => { %>
    <% if (!userBets[bet.display_name]) userBets[bet.display_name] = []; %>
    <% userBets[bet.display_name].push(bet); %>
<% }); %>

<% Object.keys(userBets).forEach(userName => { %>
    <% let userTotalBet = 0, userTotalPayout = 0, userHitCount = 0; %>
    <% userBets[userName].forEach(bet => { %>
        <% userTotalBet += bet.amount; %>
        <% userTotalPayout += bet.payout_amount || 0; %>
        <% if (bet.payout_amount && bet.payout_amount > 0) userHitCount++; %>
    <% }); %>
    <% const userProfit = userTotalPayout - userTotalBet; %>
    
    <div style="margin-bottom: 20px; border: 2px solid <%= userProfit >= 0 ? '#4caf50' : '#f44336' %>; border-radius: 8px; padding: 15px; background: #f9f9f9;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="color: #667eea; margin: 0;">ğŸ‘¤ <%= userName %></h3>
            <div style="text-align: right;">
                <div style="font-size: 12px; color: #888;">çš„ä¸­ç‡: <%= userBets[userName].length > 0 ? (userHitCount * 100 / userBets[userName].length).toFixed(1) : 0 %>%ï¼ˆ<%= userHitCount %>/<%= userBets[userName].length %>ï¼‰</div>
                <div style="font-size: 18px; font-weight: bold; color: <%= userProfit >= 0 ? '#4caf50' : '#f44336' %>;">
                    åæ”¯: <%= userProfit >= 0 ? '+' : '' %><%= userProfit.toLocaleString() %>å††
                </div>
            </div>
        </div>
        
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: white;">
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">é¦¬åˆ¸ç¨®åˆ¥</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">é¦¬ç•ª</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">é‡‘é¡</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">çµæœ</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">é…å½“</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">åæ”¯</th>
                </tr>
            </thead>
            <tbody>
                <% userBets[userName].forEach(bet => { %>
                    <% const isHit = bet.payout_amount && bet.payout_amount > 0; %>
                    <% const profit = bet.payout_amount ? bet.payout_amount - bet.amount : -bet.amount; %>
                    <tr style="background: <%= isHit ? '#e8f5e9' : bet.payout_amount !== null ? '#ffebee' : 'white' %>;">
                        <td style="padding: 8px; border-bottom: 1px solid #eee;"><%= betTypeNames[bet.bet_type] %></td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;"><strong><%= bet.horses.replace(/,/g, '-') %></strong></td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;"><%= bet.amount.toLocaleString() %>å††</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">
                            <% if (bet.payout_amount === null) { %>
                            <span style="color: #888;">æœªç¢ºå®š</span>
                            <% } else if (isHit) { %>
                            <span style="color: #4caf50; font-weight: bold;">âœ… çš„ä¸­</span>
                            <% } else { %>
                            <span style="color: #f44336;">âŒ</span>
                            <% } %>
                        </td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">
                            <% if (bet.payout_amount !== null) { %>
                            <%= parseInt(bet.payout_amount).toLocaleString() %>å††
                            <% } else { %>
                            -
                            <% } %>
                        </td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; color: <%= profit >= 0 ? '#4caf50' : '#f44336' %>; font-weight: bold;">
                            <% if (bet.payout_amount !== null) { %>
                            <%= profit >= 0 ? '+' : '' %><%= profit.toLocaleString() %>å††
                            <% } else { %>
                            -
                            <% } %>
                        </td>
                    </tr>
                <% }); %>
            </tbody>
        </table>
    </div>
<% }); %>
<% } %>
</div>

<div class="section">
<h2>ğŸ¯ é…å½“è¨ˆç®—</h2>
<p>ã“ã®ãƒ¬ãƒ¼ã‚¹ã®å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¦¬åˆ¸ã«å¯¾ã—ã¦æ‰•æˆ»é‡‘ã‚’è‡ªå‹•è¨ˆç®—ã—ã¾ã™ã€‚</p>
<button id="calculate-btn" class="btn btn-success" style="margin-top: 15px;">é…å½“ã‚’è¨ˆç®—ã™ã‚‹</button>
<div id="result-message" style="margin-top: 15px;"></div>
</div>

</div>
<script>
document.getElementById('calculate-btn').addEventListener('click', async () => {
if (!confirm('é…å½“ã‚’è¨ˆç®—ã—ã¾ã™ã‹ï¼Ÿæ—¢ã«è¨ˆç®—æ¸ˆã¿ã®å ´åˆã¯å†è¨ˆç®—ã•ã‚Œã¾ã™ã€‚')) return;
const btn = document.getElementById('calculate-btn');
const msg = document.getElementById('result-message');
btn.disabled = true;
btn.textContent = 'è¨ˆç®—ä¸­...';
msg.textContent = '';
try {
const response = await fetch('/races/<%= race.race_id %>/calculate-payouts', {
method: 'POST',
headers: { 'Content-Type': 'application/json' }
});
const result = await response.json();
if (result.success) {
msg.innerHTML = `<div style="color: #4caf50; font-weight: bold;">âœ… é…å½“è¨ˆç®—å®Œäº†: ${result.calculated}ä»¶çš„ä¸­ / ${result.total}ä»¶</div>`;
} else {
msg.innerHTML = `<div style="color: #f44336;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>`;
}
} catch (error) {
msg.innerHTML = `<div style="color: #f44336;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>`;
} finally {
btn.disabled = false;
btn.textContent = 'é…å½“ã‚’è¨ˆç®—ã™ã‚‹';
}
});

// netkeibaã‹ã‚‰ãƒ¬ãƒ¼ã‚¹çµæœã‚’è‡ªå‹•å–å¾—
async function fetchResultFromNetkeiba() {
    if (!confirm('netkeibaã‹ã‚‰ãƒ¬ãƒ¼ã‚¹çµæœã‚’è‡ªå‹•å–å¾—ã—ã¾ã™ã‹ï¼Ÿ\næ—¢å­˜ã®çµæœãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚')) {
        return;
    }
    
    try {
        const response = await fetch('/admin/fetch-result/<%= race.race_id %>', {
            method: 'POST'
        });
        
        const text = await response.text();
        
        if (response.ok) {
            alert(text);
            location.reload();
        } else {
            alert('ã‚¨ãƒ©ãƒ¼: ' + text);
        }
    } catch (error) {
        console.error(error);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    }
}
</script>
</body>
</html>
