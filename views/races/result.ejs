<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ¬ãƒ¼ã‚¹çµæœ - <%= race.race_name %></title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
.container { max-width: 1200px; margin: 0 auto; }
.header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
.header h1 { color: #333; margin-bottom: 10px; }
.back-link { display: inline-block; margin-top: 10px; color: #667eea; text-decoration: none; }
.back-link:hover { text-decoration: underline; }
.section { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
.section h2 { color: #333; margin-bottom: 15px; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
table { width: 100%; border-collapse: collapse; }
th { background: #667eea; color: white; padding: 12px; text-align: left; }
td { padding: 12px; border-bottom: 1px solid #eee; }
tr:hover { background: #f5f5f5; }
.rank-1 { background: #ffd700 !important; font-weight: bold; }
.rank-2 { background: #c0c0c0 !important; }
.rank-3 { background: #cd7f32 !important; }
.payout-item { display: flex; justify-content: space-between; padding: 10px; background: #f5f5f5; margin-bottom: 5px; border-radius: 5px; }
.btn { padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
.btn:hover { background: #5568d3; }
.btn-success { background: #4caf50; }
.btn-success:hover { background: #45a049; }
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>ğŸ <%= race.race_name %> - ãƒ¬ãƒ¼ã‚¹çµæœ</h1>
<p>ğŸ“… <%= new Date(race.race_date).toLocaleDateString('ja-JP') %> | ğŸ“ <%= race.venue %></p>
<a href="/races/<%= race.race_id %>" class="back-link">â† å‡ºé¦¬è¡¨ã«æˆ»ã‚‹</a>
<a href="/races" class="back-link">â† ãƒ¬ãƒ¼ã‚¹ä¸€è¦§</a>
</div>
<div class="section">
<h2>ğŸ† ç€é †</h2>
<% if (results.length === 0) { %>
<p style="color: #888;">ã¾ã çµæœãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
<% } else { %>
<% 
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—ï¼ˆäºˆæƒ³ã‚’å…¥åŠ›ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
const uniqueUsers = [...new Set(predictions.map(p => p.user_id))];
const userMap = {};
predictions.forEach(p => {
    if (!userMap[p.user_id]) {
        userMap[p.user_id] = p.display_name;
    }
});
%>
<table>
<thead>
<tr>
<th>ç€é †</th><th>é¦¬ç•ª</th><th>é¦¬å</th><th>é¨æ‰‹</th><th>ã‚¿ã‚¤ãƒ </th>
<% uniqueUsers.forEach(userId => { %>
    <th style="background: #f0f0f0; min-width: 50px;"><%= userMap[userId] %></th>
<% }); %>
</tr>
</thead>
<tbody>
<% results.forEach(result => { %>
<tr class="<%= result.rank <= 3 ? `rank-${result.rank}` : '' %>">
<td><strong><%= result.rank %></strong></td>
<td><%= result.umaban %></td>
<td><%= result.horse_name %></td>
<td><%= result.jockey %></td>
<td><%= result.result_time || '-' %></td>
<% uniqueUsers.forEach(userId => { %>
    <% 
    const userPred = predictions.find(p => p.umaban == result.umaban && p.user_id == userId);
    %>
    <td style="text-align: center; font-size: 18px;">
        <%= userPred ? userPred.mark : '-' %>
    </td>
<% }); %>
</tr>
<% }); %>
</tbody>
</table>
<% } %>
</div>
<div class="section">
<h2>ğŸ’° æ‰•æˆ»é‡‘</h2>
<% if (payouts.length === 0) { %>
<p style="color: #888;">ã¾ã æ‰•æˆ»é‡‘ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
<% } else { %>
<% const betTypeNames = { 'tansho': 'å˜å‹', 'fukusho': 'è¤‡å‹', 'umaren': 'é¦¬é€£', 'umatan': 'é¦¬å˜', 'wide': 'ãƒ¯ã‚¤ãƒ‰', 'sanrenpuku': '3é€£è¤‡', 'sanrentan': '3é€£å˜' }; %>
<% let currentType = ''; %>
<% payouts.forEach(payout => { %>
<% if (currentType !== payout.bet_type) { %>
<% if (currentType) { %></div><% } %>
<h3 style="margin-top: 15px; color: #667eea;"><%= betTypeNames[payout.bet_type] %></h3>
<div>
<% currentType = payout.bet_type; %>
<% } %>
<div class="payout-item">
<span><strong><%= payout.combination %></strong></span>
<span><%= payout.payout.toLocaleString() %>å††</span>
</div>
<% }); %>
<% if (currentType) { %></div><% } %>
<% } %>
</div>

<div class="section">
<h2>ğŸ« è³¼å…¥æ¸ˆã¿é¦¬åˆ¸ä¸€è¦§</h2>
<% if (allBets.length === 0) { %>
<p style="color: #888;">ã¾ã é¦¬åˆ¸ãŒè³¼å…¥ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
<% } else { %>
<% const betTypeNames = { 'tansho': 'å˜å‹', 'fukusho': 'è¤‡å‹', 'umaren': 'é¦¬é€£', 'umatan': 'é¦¬å˜', 'wide': 'ãƒ¯ã‚¤ãƒ‰', 'sanrenpuku': '3é€£è¤‡', 'sanrentan': '3é€£å˜' }; %>
<% const userBets = {}; %>
<% allBets.forEach(bet => { %>
    <% if (!userBets[bet.display_name]) userBets[bet.display_name] = []; %>
    <% userBets[bet.display_name].push(bet); %>
<% }); %>

<% Object.keys(userBets).forEach(userName => { %>
    <% let userTotalBet = 0, userTotalPayout = 0, userHitCount = 0; %>
    <% userBets[userName].forEach(bet => { %>
        <% userTotalBet += bet.amount; %>
        <% userTotalPayout += bet.payout_amount || 0; %>
        <% if (bet.payout_amount && bet.payout_amount > 0) userHitCount++; %>
    <% }); %>
    <% const userProfit = userTotalPayout - userTotalBet; %>
    
    <div style="margin-bottom: 20px; border: 2px solid <%= userProfit >= 0 ? '#4caf50' : '#f44336' %>; border-radius: 8px; padding: 15px; background: #f9f9f9;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="color: #667eea; margin: 0;">ğŸ‘¤ <%= userName %></h3>
            <div style="text-align: right;">
                <div style="font-size: 12px; color: #888;">çš„ä¸­ç‡: <%= userBets[userName].length > 0 ? (userHitCount * 100 / userBets[userName].length).toFixed(1) : 0 %>%ï¼ˆ<%= userHitCount %>/<%= userBets[userName].length %>ï¼‰</div>
                <div style="font-size: 18px; font-weight: bold; color: <%= userProfit >= 0 ? '#4caf50' : '#f44336' %>;">
                    åæ”¯: <%= userProfit >= 0 ? '+' : '' %><%= userProfit.toLocaleString() %>å††
                </div>
            </div>
        </div>
        
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: white;">
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">é¦¬åˆ¸ç¨®åˆ¥</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">é¦¬ç•ª</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">é‡‘é¡</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">çµæœ</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">é…å½“</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">åæ”¯</th>
                </tr>
            </thead>
            <tbody>
                <% userBets[userName].forEach(bet => { %>
                    <% const isHit = bet.payout_amount && bet.payout_amount > 0; %>
                    <% const profit = bet.payout_amount ? bet.payout_amount - bet.amount : -bet.amount; %>
                    <tr style="background: <%= isHit ? '#e8f5e9' : bet.payout_amount !== null ? '#ffebee' : 'white' %>;">
                        <td style="padding: 8px; border-bottom: 1px solid #eee;"><%= betTypeNames[bet.bet_type] %></td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;"><strong><%= bet.horses %></strong></td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;"><%= bet.amount.toLocaleString() %>å††</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">
                            <% if (bet.payout_amount === null) { %>
                            <span style="color: #888;">æœªç¢ºå®š</span>
                            <% } else if (isHit) { %>
                            <span style="color: #4caf50; font-weight: bold;">âœ… çš„ä¸­</span>
                            <% } else { %>
                            <span style="color: #f44336;">âŒ</span>
                            <% } %>
                        </td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">
                            <% if (bet.payout_amount !== null) { %>
                            <%= parseInt(bet.payout_amount).toLocaleString() %>å††
                            <% } else { %>
                            -
                            <% } %>
                        </td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; color: <%= profit >= 0 ? '#4caf50' : '#f44336' %>; font-weight: bold;">
                            <% if (bet.payout_amount !== null) { %>
                            <%= profit >= 0 ? '+' : '' %><%= profit.toLocaleString() %>å††
                            <% } else { %>
                            -
                            <% } %>
                        </td>
                    </tr>
                <% }); %>
            </tbody>
        </table>
    </div>
<% }); %>
<% } %>
</div>

<div class="section">
<h2>ğŸ¯ é…å½“è¨ˆç®—</h2>
<p>ã“ã®ãƒ¬ãƒ¼ã‚¹ã®å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¦¬åˆ¸ã«å¯¾ã—ã¦æ‰•æˆ»é‡‘ã‚’è‡ªå‹•è¨ˆç®—ã—ã¾ã™ã€‚</p>
<button id="calculate-btn" class="btn btn-success" style="margin-top: 15px;">é…å½“ã‚’è¨ˆç®—ã™ã‚‹</button>
<div id="result-message" style="margin-top: 15px;"></div>
</div>

</div>
<script>
document.getElementById('calculate-btn').addEventListener('click', async () => {
if (!confirm('é…å½“ã‚’è¨ˆç®—ã—ã¾ã™ã‹ï¼Ÿæ—¢ã«è¨ˆç®—æ¸ˆã¿ã®å ´åˆã¯å†è¨ˆç®—ã•ã‚Œã¾ã™ã€‚')) return;
const btn = document.getElementById('calculate-btn');
const msg = document.getElementById('result-message');
btn.disabled = true;
btn.textContent = 'è¨ˆç®—ä¸­...';
msg.textContent = '';
try {
const response = await fetch('/races/<%= race.race_id %>/calculate-payouts', {
method: 'POST',
headers: { 'Content-Type': 'application/json' }
});
const result = await response.json();
if (result.success) {
msg.innerHTML = `<div style="color: #4caf50; font-weight: bold;">âœ… é…å½“è¨ˆç®—å®Œäº†: ${result.calculated}ä»¶çš„ä¸­ / ${result.total}ä»¶</div>`;
} else {
msg.innerHTML = `<div style="color: #f44336;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>`;
}
} catch (error) {
msg.innerHTML = `<div style="color: #f44336;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>`;
} finally {
btn.disabled = false;
btn.textContent = 'é…å½“ã‚’è¨ˆç®—ã™ã‚‹';
}
});
</script>
</body>
</html>
