<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ¬ãƒ¼ã‚¹çµæœ - <%= race.race_name %></title>
<%- include('../pwa_head') %>
<link rel="stylesheet" href="/css/betting-ticket-styles.css">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); background-attachment: fixed; min-height: 100vh; padding: 20px; }
.container { max-width: 1200px; margin: 0 auto; }
.header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 30px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.3); }
.header h1 { color: #333; margin-bottom: 15px; font-size: 1.8rem; font-weight: 700; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.header p { color: #666; font-weight: 500; margin-top: 10px; }
.back-link { display: inline-block; margin-top: 10px; margin-right: 15px; color: #667eea; text-decoration: none; font-weight: 600; transition: all 0.3s; padding: 5px 10px; border-radius: 5px; }
.back-link:hover { background: rgba(102, 126, 234, 0.1); transform: translateX(-5px); }
.section { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 30px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 8px 30px rgba(0,0,0,0.12); border: 1px solid rgba(255,255,255,0.3); }
.section h2 { color: #333; margin-bottom: 20px; border-bottom: 3px solid transparent; border-image: linear-gradient(90deg, #667eea 0%, #764ba2 100%); border-image-slice: 1; padding-bottom: 12px; font-size: 1.5rem; font-weight: 700; }
table { width: 100%; border-collapse: collapse; }
th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 14px 12px; text-align: left; font-weight: 600; }
td { padding: 12px; border-bottom: 1px solid #eee; }
tr:hover { background: #f5f5f5; }
.rank-1 { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%) !important; font-weight: bold; }
.rank-2 { background: linear-gradient(135deg, #c0c0c0 0%, #e0e0e0 100%) !important; font-weight: bold; }
.rank-3 { background: linear-gradient(135deg, #cd7f32 0%, #e8a87c 100%) !important; font-weight: bold; }
tr.no-rank { opacity: 0.5; background: #f9f9f9; }
tr.no-rank td { color: #999; }
.payout-item { display: flex; justify-content: space-between; padding: 10px; background: #f5f5f5; margin-bottom: 5px; border-radius: 5px; }
.btn { padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
.btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6); }
.btn-success { background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4); }
.btn-success:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6); }

/* ã‚¹ãƒãƒ›å¯¾å¿œ */
@media (max-width: 768px) {
    body { padding: 10px; }
    .header, .section { padding: 15px; }
    .header h1 { font-size: 1.3rem; }
    .header p { font-size: 0.9rem; }
    .back-link { display: block; margin: 5px 0; }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ« */
    table { font-size: 0.75rem; display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; min-width: 100%; }
    th, td { padding: 6px 3px; white-space: normal !important; word-wrap: break-word; }
    
    /* ãƒœã‚¿ãƒ³ */
    .btn { width: 100%; margin: 5px 0; }
    
    /* é…å½“è¡¨ç¤º */
    .payout-item { flex-direction: column; gap: 5px; }
}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>ğŸ <%= race.race_name %> - ãƒ¬ãƒ¼ã‚¹çµæœ</h1>
<p>ğŸ“… <%= new Date(race.race_date).toLocaleDateString('ja-JP') %> | ğŸ“ <%= race.venue %></p>
<%- include('../common_nav', { currentPage: 'races', user: user }) %>
<div style="margin-top: 15px;">
<% if (user && user.is_admin) { %>
<button onclick="fetchResultFromNetkeiba()" class="btn" style="background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%); box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);">
ğŸŒ netkeibaã‹ã‚‰çµæœã‚’è‡ªå‹•å–å¾—
</button>
<% } %>
</div>
<a href="/races/<%= race.race_id %>" class="back-link">â† å‡ºé¦¬è¡¨ã«æˆ»ã‚‹</a>
<a href="/races" class="back-link">â† ãƒ¬ãƒ¼ã‚¹ä¸€è¦§</a>
</div>
<div class="section">
<h2>ğŸ† ç€é †</h2>
<% if (results.length === 0) { %>
<p style="color: #888;">ã¾ã çµæœãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
<% } else { %>
<% 
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—ï¼ˆäºˆæƒ³ã‚’å…¥åŠ›ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
const uniqueUsers = [...new Set(predictions.map(p => p.user_id))];
const userMap = {};
predictions.forEach(p => {
    if (!userMap[p.user_id]) {
        userMap[p.user_id] = p.display_name;
    }
});
%>
<table>
<thead>
<tr>
<th>ç€é †</th><th>é¦¬ç•ª</th><th>é¦¬å</th><th>é¨æ‰‹</th><th>ã‚¿ã‚¤ãƒ </th>
<% uniqueUsers.forEach(userId => { %>
    <th style="background: #667eea; color: white; font-weight: bold; min-width: 50px;"><%= userMap[userId] %></th>
<% }); %>
</tr>
</thead>
<tbody>
<% results.forEach(result => { %>
<%
// ç€é †ãŒã‚ã‚‹ã‹ã©ã†ã‹ã§è¡Œã®ã‚¯ãƒ©ã‚¹ã‚’å¤‰æ›´
let rowClass = '';
if (result.rank) {
    if (result.rank <= 3) {
        rowClass = `rank-${result.rank}`;
    }
} else {
    rowClass = 'no-rank';
}
%>
<tr class="<%= rowClass %>">
<td><strong><%= result.rank || '-' %></strong></td>
<td><strong><%= result.umaban %></strong></td>
<td><%= result.horse_name %></td>
<td><%= result.jockey %></td>
<td><%= result.result_time || '-' %></td>
<% uniqueUsers.forEach(userId => { %>
    <% 
    const userPred = predictions.find(p => p.umaban == result.umaban && p.user_id == userId);
    %>
    <td style="text-align: center; font-size: 18px;">
        <%= userPred ? userPred.mark : '-' %>
    </td>
<% }); %>
</tr>
<% }); %>
</tbody>
</table>
<% } %>
</div>
<div class="section">
<h2>ğŸ’° æ‰•æˆ»é‡‘</h2>
<% if (payouts.length === 0) { %>
<p style="color: #888;">ã¾ã æ‰•æˆ»é‡‘ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
<% } else { %>
<% const betTypeNames = { 'tansho': 'å˜å‹', 'fukusho': 'è¤‡å‹', 'umaren': 'é¦¬é€£', 'umatan': 'é¦¬å˜', 'wide': 'ãƒ¯ã‚¤ãƒ‰', 'sanrenpuku': '3é€£è¤‡', 'sanrentan': '3é€£å˜' }; %>
<% 
// æ‰•æˆ»é‡‘ã‚’æŒ‡å®šé †ã§ã‚½ãƒ¼ãƒˆ
const betTypeOrder = { 'tansho': 1, 'fukusho': 2, 'umaren': 3, 'wide': 4, 'sanrenpuku': 5, 'sanrentan': 6 };
const sortedPayouts = payouts.sort((a, b) => {
    return (betTypeOrder[a.bet_type] || 99) - (betTypeOrder[b.bet_type] || 99);
});
%>
<% let currentType = ''; %>
<% sortedPayouts.forEach(payout => { %>
<% if (currentType !== payout.bet_type) { %>
<% if (currentType) { %></div><% } %>
<h3 style="margin-top: 15px; color: #667eea;"><%= betTypeNames[payout.bet_type] %></h3>
<div>
<% currentType = payout.bet_type; %>
<% } %>
<div class="payout-item">
<span><strong><%= payout.combination.replace(/,/g, '-') %></strong></span>
<span><%= payout.payout.toLocaleString() %>å††</span>
</div>
<% }); %>
<% if (currentType) { %></div><% } %>
<% } %>
</div>

<div class="section">
<h2>ğŸ« è³¼å…¥æ¸ˆã¿é¦¬åˆ¸ä¸€è¦§</h2>
<% if (allBets.length === 0) { %>
<p style="color: #888;">ã¾ã é¦¬åˆ¸ãŒè³¼å…¥ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
<% } else { %>
<% const betTypeNames = { 'tansho': 'å˜å‹', 'fukusho': 'è¤‡å‹', 'umaren': 'é¦¬é€£', 'umatan': 'é¦¬å˜', 'wide': 'ãƒ¯ã‚¤ãƒ‰', 'sanrenpuku': '3é€£è¤‡', 'sanrentan': '3é€£å˜' }; %>
<% const userBets = {}; %>
<% allBets.forEach(bet => { %>
    <% if (!userBets[bet.display_name]) userBets[bet.display_name] = []; %>
    <% userBets[bet.display_name].push(bet); %>
<% }); %>

<% Object.keys(userBets).forEach(userName => { %>
    <%
    // ç™ºèµ°æ™‚åˆ»ã‚’ãƒã‚§ãƒƒã‚¯
    const now = new Date();
    const raceDateTime = new Date(race.race_date);
    const [hours, minutes] = race.race_time.split(':');
    raceDateTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
    const isTestMode = process.env.TEST_MODE === 'true';
    const canDeleteBets = isTestMode || (now < raceDateTime);
    
    let userTotalBet = 0, userTotalPayout = 0;
    let hasHit = false;
    userBets[userName].forEach(bet => {
        userTotalBet += bet.amount;
        userTotalPayout += bet.payout_amount || 0;
        if (bet.payout_amount && bet.payout_amount > 0) hasHit = true;
    });
    const userProfit = userTotalPayout - userTotalBet;
    const hitRate = hasHit ? 100 : 0;
    %>
    
    <div style="margin-bottom: 20px; border: 2px solid <%= userProfit >= 0 ? '#4caf50' : '#f44336' %>; border-radius: 8px; padding: 15px; background: #f9f9f9;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <h3 style="color: #667eea; margin: 0;">ğŸ‘¤ <%= userName %></h3>
                <% if (user && user.display_name === userName && canDeleteBets) { %>
                    <button onclick="deleteMyBets()" style="padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">ğŸ—‘ï¸ å‰Šé™¤</button>
                <% } %>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 12px; color: #888;">ã“ã®ãƒ¬ãƒ¼ã‚¹: <%= hasHit ? 'âœ… çš„ä¸­' : 'âŒ ä¸çš„ä¸­' %></div>
                <div style="font-size: 18px; font-weight: bold; color: <%= userProfit >= 0 ? '#4caf50' : '#f44336' %>;">
                    åæ”¯: <%= userProfit >= 0 ? '+' : '' %><%= userProfit.toLocaleString() %>å††
                </div>
            </div>
        </div>
        
        <!-- é¦¬åˆ¸ã‚«ãƒ¼ãƒ‰è¡¨ç¤º -->
        <div class="ticket-container">
            <% 
            // é¦¬åˆ¸ç¨®åˆ¥ã®é †åº
            const betTypeOrder = { 'tansho': 1, 'fukusho': 2, 'umaren': 3, 'wide': 4, 'umatan': 5, 'sanrenpuku': 6, 'sanrentan': 7 };
            // ã‚½ãƒ¼ãƒˆ
            const sortedUserBets = userBets[userName].sort((a, b) => {
                return (betTypeOrder[a.bet_type] || 99) - (betTypeOrder[b.bet_type] || 99);
            });
            
            sortedUserBets.forEach(bet => { 
                // é¦¬åˆ¸ç¨®åˆ¥åã¨ã‚¢ã‚¤ã‚³ãƒ³
                const betTypeIcons = {
                    'tansho': 'ğŸ‡', 'fukusho': 'ğŸ¯', 'umaren': 'ğŸ¤',
                    'wide': 'ğŸ“Š', 'umatan': 'â¡ï¸', 
                    'sanrenpuku': 'ğŸ’', 'sanrentan': 'ğŸŒŸ'
                };
                
                const betTypeName = betTypeNames[bet.bet_type] || bet.bet_type;
                const betTypeIcon = betTypeIcons[bet.bet_type] || 'ğŸ«';
                
                // è³¼å…¥å½¢å¼ã‚’å–å¾—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å˜å¼ï¼‰
                const betFormat = bet.bet_format || 'single';
                
                // é¦¬ç•ªã‚’é…åˆ—ã«å¤‰æ›
                let horses = [];
                let formationGroups = [];
                
                if (betFormat === 'formation' && bet.horses.includes('>')) {
                    // ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: '6>3,5,7>2,3,4,5,7,8,9'
                    formationGroups = bet.horses.split('>').map(group => 
                        group.split(',').map(h => h.trim())
                    );
                } else {
                    // å˜å¼ãƒ»ãƒœãƒƒã‚¯ã‚¹: '2,4,12'
                    horses = bet.horses.split(',').map(h => h.trim());
                }
                
                // å˜å‹ãƒ»è¤‡å‹ã‹ã©ã†ã‹
                const isSingle = bet.bet_type === 'tansho' || bet.bet_type === 'fukusho';
                
                // é¦¬åå–å¾—ï¼ˆå˜å‹ãƒ»è¤‡å‹ã®å˜å¼ã®å ´åˆï¼‰
                let horseName = '';
                if (isSingle && betFormat === 'single' && horses_data) {
                    const horseInfo = horses_data.find(h => h.umaban.toString() === horses[0]);
                    horseName = horseInfo ? horseInfo.horse_name : '';
                }
                
                // çš„ä¸­åˆ¤å®š
                const isHit = bet.payout_amount && bet.payout_amount > 0;
                const payout = bet.payout_amount || 0;
                const profit = payout - bet.amount;
                const hasResult = bet.payout_amount !== null && bet.payout_amount !== undefined;
                const resultClass = hasResult ? (isHit ? 'ticket-result-hit' : 'ticket-result-miss') : 'ticket-result-pending';
                
                // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const raceDate = new Date(race.race_date).toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }).replace(/\//g, '.');
                
                // ãƒ¬ãƒ¼ã‚¹ç•ªå·ã‚’å–å¾—ï¼ˆrace_idã®æœ€å¾Œã®2æ¡ï¼‰
                const raceNumber = race.race_id.toString().slice(-2);
            %>
            
            <div class="betting-ticket ticket-<%= bet.bet_type %>">
                <!-- å·¦å´ï¼šé»’ã„ã‚¨ãƒªã‚¢ï¼ˆãƒ¬ãƒ¼ã‚¹ç•ªå· + QRã‚³ãƒ¼ãƒ‰ï¼‰ -->
                <div class="ticket-left-section">
                    <div class="ticket-race-number"><%= raceNumber %></div>
                    <div class="ticket-qr-area">
                        <div class="ticket-qr"></div>
                        <div class="ticket-qr"></div>
                    </div>
                    <div class="ticket-race-label">ãƒ¬ãƒ¼ã‚¹</div>
                </div>
                
                <!-- ä¸­å¤®ï¼šå¤§ããç¸¦æ›¸ãã§é¦¬åˆ¸ç¨®åˆ¥ -->
                <div class="ticket-center-type">
                    <div class="ticket-type-large"><%= betTypeName %></div>
                </div>
                
                <!-- å³å´ï¼šé¦¬ç•ªãƒ»é¦¬åãƒ»é‡‘é¡ -->
                <div class="ticket-right-content">
                    <!-- ä¸Šéƒ¨ï¼šæ—¥ä»˜ã¨ãƒ¬ãƒ¼ã‚¹å -->
                    <div class="ticket-header">
                        <div class="ticket-date-info"><%= raceDate %></div>
                        <div class="ticket-race-info"><%= race.race_name %></div>
                    </div>
                    
                    <!-- é¦¬ç•ªã¨é¦¬å -->
                    <div class="ticket-horse-area">
                        <% if (isSingle && betFormat === 'single') { %>
                            <!-- å˜å‹ãƒ»è¤‡å‹ã®å˜å¼ -->
                            <div class="ticket-umaban-box">
                                <div class="ticket-umaban"><%= horses[0] %></div>
                            </div>
                            <div class="ticket-horse-details">
                                <% if (horseName) { %>
                                    <div class="ticket-horse-name"><%= horseName %></div>
                                <% } %>
                                <div class="ticket-amount"><%= bet.amount.toLocaleString() %>å††</div>
                            </div>
                        <% } else if (betFormat === 'box') { %>
                            <!-- ãƒœãƒƒã‚¯ã‚¹è²·ã„ -->
                            <div>
                                <div style="font-size: 14px; font-weight: bold; margin-bottom: 5px;">BOX</div>
                                <div class="ticket-box-numbers">
                                    <% horses.forEach((h, i) => { %>
                                        <span class="box-number"><%= h %></span><%= i < horses.length - 1 ? ' ' : '' %>
                                    <% }); %>
                                </div>
                                <div style="font-size: 11px; margin-top: 5px; color: #666;">
                                    çµ„åˆã›æ•°: <%= horses.length %>é ­ BOX
                                </div>
                                <div class="ticket-amount" style="margin-top: 5px;"><%= bet.amount.toLocaleString() %>å††</div>
                            </div>
                        <% } else if (betFormat === 'formation') { %>
                            <!-- ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è²·ã„ -->
                            <div>
                                <div style="font-size: 12px; font-weight: bold; margin-bottom: 3px;">ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</div>
                                
                                <% if (bet.bet_type === 'umatan') { %>
                                    <!-- é¦¬å˜ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼šç€é †è¡¨ç¤º -->
                                    <div class="ticket-formation">
                                        <% formationGroups.forEach((group, idx) => { %>
                                            <div class="formation-group">
                                                <span class="formation-label"><%= idx + 1 %>ç€</span>
                                                <div class="formation-horses">
                                                    <% group.forEach((h, i) => { %>
                                                        <span class="formation-number"><%= h %></span><% if (i < group.length - 1) { %><span style="margin: 0 1px;">,</span><% } %>
                                                    <% }); %>
                                                </div>
                                            </div>
                                            <% if (idx < formationGroups.length - 1) { %>
                                                <div style="text-align: center; font-size: 14px; color: #667eea; font-weight: bold; margin: 2px 0;">â†“</div>
                                            <% } %>
                                        <% }); %>
                                    </div>
                                <% } else if (bet.bet_type === 'sanrentan') { %>
                                    <!-- 3é€£å˜ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼šç€é †è¡¨ç¤º -->
                                    <div class="ticket-formation">
                                        <% formationGroups.forEach((group, idx) => { %>
                                            <div class="formation-group">
                                                <span class="formation-label"><%= idx + 1 %>ç€</span>
                                                <div class="formation-horses">
                                                    <% group.forEach((h, i) => { %>
                                                        <span class="formation-number"><%= h %></span><% if (i < group.length - 1) { %><span style="margin: 0 1px;">,</span><% } %>
                                                    <% }); %>
                                                </div>
                                            </div>
                                            <% if (idx < formationGroups.length - 1) { %>
                                                <div style="text-align: center; font-size: 14px; color: #667eea; font-weight: bold; margin: 2px 0;">â†“</div>
                                            <% } %>
                                        <% }); %>
                                    </div>
                                <% } else { %>
                                    <!-- ãã®ä»–ã®ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ -->
                                    <div class="ticket-formation">
                                        <% formationGroups.forEach((group, idx) => { %>
                                            <div class="formation-group">
                                                <span class="formation-arrow">â–¶</span>
                                                <div class="formation-horses">
                                                    <% group.forEach((h, i) => { %>
                                                        <span class="formation-number"><%= h %></span>
                                                    <% }); %>
                                                </div>
                                            </div>
                                        <% }); %>
                                    </div>
                                <% } %>
                                
                                <div style="font-size: 10px; margin-top: 3px; color: #666;">
                                    çµ„åˆã›æ•°: <%= bet.bet_count %>ç‚¹
                                </div>
                                <div class="ticket-amount" style="margin-top: 5px;"><%= bet.amount.toLocaleString() %>å††</div>
                            </div>
                        <% } else { %>
                            <!-- ãã®ä»–ï¼ˆå˜å¼ã®2é€£ç³»ãƒ»3é€£ç³»ï¼‰ -->
                            <div>
                                <% 
                                // ç€é †ãŒã‚ã‚‹é¦¬åˆ¸ï¼ˆé¦¬å˜ãƒ»3é€£å˜ï¼‰ã¯â†’ã€ãã‚Œä»¥å¤–ã¯-
                                const delimiter = (bet.bet_type === 'umatan' || bet.bet_type === 'sanrentan') ? 'â†’' : '-';
                                %>
                                <div class="ticket-numbers"><%= horses.join(delimiter) %></div>
                                <div class="ticket-amount"><%= bet.amount.toLocaleString() %>å††</div>
                            </div>
                        <% } %>
                    </div>
                    
                    <!-- çµæœè¡¨ç¤º -->
                    <% if (hasResult) { %>
                        <div class="ticket-result-area">
                            <div class="ticket-payout">æ‰•æˆ»: Â¥<%= payout.toLocaleString() %></div>
                            <div class="ticket-profit <%= profit >= 0 ? 'profit-plus' : 'profit-minus' %>">
                                <%= profit >= 0 ? '+' : '' %>Â¥<%= profit.toLocaleString() %>
                            </div>
                        </div>
                    <% } %>
                </div>
                
                <!-- çš„ä¸­ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆå·¦å´ï¼‰ -->
                <% if (hasResult && isHit) { %>
                    <div class="ticket-stamp stamp-hit">çš„ä¸­</div>
                <% } else if (hasResult && !isHit) { %>
                    <div class="ticket-stamp stamp-miss">ãƒã‚ºãƒ¬</div>
                <% } %>
            </div>
            
            <% }); %>
        </div>
    </div>
<% }); %>
<% } %>
</div>

<div class="section">
<h2>ğŸ¯ é…å½“è¨ˆç®—</h2>
<p>ã“ã®ãƒ¬ãƒ¼ã‚¹ã®å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¦¬åˆ¸ã«å¯¾ã—ã¦æ‰•æˆ»é‡‘ã‚’è‡ªå‹•è¨ˆç®—ã—ã¾ã™ã€‚</p>
<button id="calculate-btn" class="btn btn-success" style="margin-top: 15px;">é…å½“ã‚’è¨ˆç®—ã™ã‚‹</button>
<div id="result-message" style="margin-top: 15px;"></div>
</div>

</div>
<script>
document.getElementById('calculate-btn').addEventListener('click', async () => {
if (!confirm('é…å½“ã‚’è¨ˆç®—ã—ã¾ã™ã‹ï¼Ÿæ—¢ã«è¨ˆç®—æ¸ˆã¿ã®å ´åˆã¯å†è¨ˆç®—ã•ã‚Œã¾ã™ã€‚')) return;
const btn = document.getElementById('calculate-btn');
const msg = document.getElementById('result-message');
btn.disabled = true;
btn.textContent = 'è¨ˆç®—ä¸­...';
msg.textContent = '';
try {
const response = await fetch('/races/<%= race.race_id %>/calculate-payouts', {
method: 'POST',
headers: { 'Content-Type': 'application/json' }
});
const result = await response.json();
if (result.success) {
msg.innerHTML = `<div style="color: #4caf50; font-weight: bold;">âœ… é…å½“è¨ˆç®—å®Œäº†: ${result.calculated}ä»¶çš„ä¸­ / ${result.total}ä»¶</div>`;
} else {
msg.innerHTML = `<div style="color: #f44336;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>`;
}
} catch (error) {
msg.innerHTML = `<div style="color: #f44336;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>`;
} finally {
btn.disabled = false;
btn.textContent = 'é…å½“ã‚’è¨ˆç®—ã™ã‚‹';
}
});

// netkeibaã‹ã‚‰ãƒ¬ãƒ¼ã‚¹çµæœã‚’è‡ªå‹•å–å¾—
async function fetchResultFromNetkeiba() {
    if (!confirm('netkeibaã‹ã‚‰ãƒ¬ãƒ¼ã‚¹çµæœã‚’è‡ªå‹•å–å¾—ã—ã¾ã™ã‹ï¼Ÿ\næ—¢å­˜ã®çµæœãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚')) {
        return;
    }
    
    try {
        const response = await fetch('/admin/fetch-result/<%= race.race_id %>', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const text = await response.text();
        
        if (response.ok) {
            alert(text);
            location.reload();
        } else {
            alert('ã‚¨ãƒ©ãƒ¼: ' + text);
        }
    } catch (error) {
        console.error(error);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    }
}

// è‡ªåˆ†ã®é¦¬åˆ¸ã‚’å‰Šé™¤
async function deleteMyBets() {
    const raceId = '<%= race.race_id %>';
    
    if (!confirm('ã“ã®ãƒ¬ãƒ¼ã‚¹ã®è‡ªåˆ†ã®è³¼å…¥é¦¬åˆ¸ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        return;
    }
    
    try {
        const response = await fetch(`/races/${raceId}/delete-my-bets`, {
            method: 'POST'
        });
        
        const text = await response.text();
        
        if (response.ok) {
            alert(text);
            // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
            location.reload();
        } else {
            alert('ã‚¨ãƒ©ãƒ¼: ' + text);
        }
    } catch (error) {
        console.error(error);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    }
}
</script>
</body>
</html>
