<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>äºˆæƒ³å…¥åŠ› - <%= race.race_name %></title>
<%- include('../pwa_head') %>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); background-attachment: fixed; min-height: 100vh; padding: 20px; }
.container { max-width: 1200px; margin: 0 auto; }
.header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 30px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.3); }
.header h1 { color: #333; margin-bottom: 15px; font-size: 1.8rem; font-weight: 700; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.back-link { display: inline-block; margin-top: 10px; color: #667eea; text-decoration: none; font-weight: 600; transition: all 0.3s; padding: 5px 10px; border-radius: 5px; }
.back-link:hover { background: rgba(102, 126, 234, 0.1); transform: translateX(-5px); }
.section { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 30px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 8px 30px rgba(0,0,0,0.12); border: 1px solid rgba(255,255,255,0.3); }
.section h2 { color: #333; margin-bottom: 20px; border-bottom: 3px solid transparent; border-image: linear-gradient(90deg, #667eea 0%, #764ba2 100%); border-image-slice: 1; padding-bottom: 12px; font-size: 1.5rem; font-weight: 700; }
table { width: 100%; border-collapse: collapse; }
th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 14px 12px; text-align: left; font-weight: 600; }
td { padding: 12px; border-bottom: 1px solid #eee; }
.mark-select { padding: 8px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 16px; }
.waku { width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; }
.waku-1 { background: white; color: #333; border: 2px solid #333; }
.waku-2 { background: black; }
.waku-3 { background: red; }
.waku-4 { background: blue; }
.waku-5 { background: yellow; color: #333; }
.waku-6 { background: green; }
.waku-7 { background: orange; }
.waku-8 { background: pink; color: #333; }
.btn { padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
.btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6); }
.btn-success { background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4); }
.btn-success:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6); }
.btn-danger { background: linear-gradient(135deg, #f44336 0%, #da190b 100%); box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4); }
.btn-danger:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(244, 67, 54, 0.6); }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; font-size: 1rem; }
.form-group select, .form-group input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; transition: all 0.3s; }
.form-group select:focus, .form-group input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
.bet-list { list-style: none; }
.bet-item { background: #f5f5f5; padding: 15px; border-radius: 5px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
.bet-info { flex: 1; }
.total-amount { font-size: 20px; font-weight: bold; color: #667eea; margin-top: 15px; }
.remaining-amount { color: #4caf50; margin-top: 5px; }
.horse-checkboxes { max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; padding: 10px; border-radius: 5px; background: #f9f9f9; }
.horse-checkbox-label { display: block; padding: 8px; margin: 5px 0; background: white; border-radius: 5px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
.horse-checkbox-label:hover { background: #f0f0f0; }
.horse-checkbox-label input[type="checkbox"] { margin-right: 10px; }
.horse-checkbox-label.selected { border-color: #4caf50; background: #e8f5e9; }
.horse-checkbox-label .waku { display: inline-block; width: 25px; height: 25px; line-height: 25px; text-align: center; border-radius: 3px; margin-right: 8px; font-size: 12px; }
.horse-checkbox-label .jockey { color: #888; margin-left: 10px; font-size: 13px; }
.horse-checkbox-label-small { display: block; padding: 5px; margin: 3px 0; background: white; border-radius: 3px; cursor: pointer; border: 2px solid transparent; font-size: 13px; }
.horse-checkbox-label-small:hover { background: #f0f0f0; }
.horse-checkbox-label-small.selected { border-color: #4caf50; background: #e8f5e9; }
.horse-checkbox-label-small input[type="checkbox"] { margin-right: 5px; }
.selection-info { margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px; font-weight: bold; color: #856404; }
.bet-input-type { display: none; }
.buy-method-option:hover { 
    transform: translateY(-4px) scale(1.02) !important; 
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2) !important; 
    border-color: #b8c5f2 !important;
}

/* ã‚¹ãƒãƒ›å¯¾å¿œ */
@media (max-width: 768px) {
    body { padding: 10px; }
    .container { max-width: 100%; }
    .header, .section { padding: 15px; }
    .header h1 { font-size: 1.3rem; }
    .section h2 { font-size: 1.1rem; }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    table { font-size: 0.75rem; display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; min-width: 100%; }
    th, td { padding: 6px 3px; white-space: normal !important; word-wrap: break-word; }
    
    /* æ ç•ªã‚’å°ã•ã */
    .waku { width: 25px !important; height: 25px !important; font-size: 0.75rem !important; line-height: 25px !important; }
    
    /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
    .form-group select, .form-group input { font-size: 16px; /* iOSã®ã‚ºãƒ¼ãƒ é˜²æ­¢ */ }
    
    /* ãƒœã‚¿ãƒ³ */
    .btn { width: 100%; margin: 5px 0; padding: 12px; font-size: 16px; }
    
    /* é¦¬åˆ¸ãƒªã‚¹ãƒˆ */
    .bet-item { flex-direction: column; align-items: flex-start; gap: 10px; }
    .bet-item button { width: 100%; }
    
    /* è³¼å…¥æ–¹æ³•é¸æŠ */
    .buy-method-options { 
        grid-template-columns: 1fr !important;
        gap: 15px !important;
    }
    .buy-method-option { 
        padding: 20px !important;
    }
    .buy-method-option div[style*="font-size: 3rem"] {
        font-size: 2.5rem !important;
    }
}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>ğŸ“ äºˆæƒ³å…¥åŠ› - <%= race.race_name %></h1>
<p>ãƒ¦ãƒ¼ã‚¶ãƒ¼: <%= user.display_name %></p>
<p style="color: #f44336; font-weight: bold;">â° ãƒ¬ãƒ¼ã‚¹é–‹å§‹æ™‚åˆ»: <%= race.race_date %> <%= race.race_time %> ï¼ˆé–‹å§‹æ™‚åˆ»ä»¥é™ã¯è³¼å…¥ä¸å¯ï¼‰</p>
<a href="/races/<%= race.race_id %>" class="back-link">â† å‡ºé¦¬è¡¨ã«æˆ»ã‚‹</a>
</div>
<div class="section">
<h2>ğŸ¯ å°ã‚’å…¥åŠ›</h2>
<form id="marks-form">
<table>
<thead><tr><th>æ </th><th>é¦¬ç•ª</th><th>é¦¬å</th><th>é¨æ‰‹</th><th>å°</th></tr></thead>
<tbody>
<% const existingMarks = {}; predictions.forEach(p => { existingMarks[p.umaban] = p.mark; }); %>
<% horses.forEach(horse => { %>
<tr>
<td><div class="waku waku-<%= horse.waku %>"><%= horse.waku %></div></td>
<td><strong><%= horse.umaban %></strong></td>
<td><%= horse.horse_name %></td>
<td><%= horse.jockey %></td>
<td><select name="mark_<%= horse.umaban %>" class="mark-select">
<option value="">-</option>
<option value="â—" <%= existingMarks[horse.umaban] === 'â—' ? 'selected' : '' %>>â—</option>
<option value="â—‹" <%= existingMarks[horse.umaban] === 'â—‹' ? 'selected' : '' %>>â—‹</option>
<option value="â–²" <%= existingMarks[horse.umaban] === 'â–²' ? 'selected' : '' %>>â–²</option>
<option value="â–³" <%= existingMarks[horse.umaban] === 'â–³' ? 'selected' : '' %>>â–³</option>
<option value="â˜†" <%= existingMarks[horse.umaban] === 'â˜†' ? 'selected' : '' %>>â˜†</option>
</select></td>
</tr>
<% }); %>
</tbody>
</table>
<div style="margin-top: 20px;">
<label for="prediction_comment" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">ğŸ’¬ äºˆæƒ³ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä»»æ„ãƒ»500æ–‡å­—ã¾ã§ï¼‰</label>
<textarea 
  id="prediction_comment" 
  name="comment" 
  rows="4" 
  maxlength="500"
  style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; resize: vertical;"
  placeholder="ã“ã®é¦¬ã‚’æœ¬å‘½ã«ã—ãŸç†ç”±ã€ãƒ¬ãƒ¼ã‚¹ã®å±•é–‹äºˆæƒ³ãªã©..."><%= predictions.length > 0 && predictions[0].comment ? predictions[0].comment : '' %></textarea>
<div style="text-align: right; font-size: 12px; color: #888; margin-top: 4px;">
  <span id="comment_count">0</span> / 500æ–‡å­—
</div>
</div>
<div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
<button type="submit" class="btn btn-success">å°ã‚’ä¿å­˜</button>
<button type="button" class="btn" onclick="autoBet()" style="background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%); box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);">
ğŸ° ãŠã¾ã‹ã›è³¼å…¥ï¼ˆè‡ªå‹•ï¼‰
</button>
</div>
</form>
</div>
<div class="section">
<h2>ğŸ’° é¦¬åˆ¸ã‚’è³¼å…¥</h2>
<form id="bet-form">
<div class="form-group">
<label for="bet_type">é¦¬åˆ¸ç¨®åˆ¥</label>
<select id="bet_type" name="bet_type" required>
<option value="tansho">å˜å‹</option>
<option value="fukusho">è¤‡å‹</option>
<option value="umaren">é¦¬é€£</option>
<option value="umatan">é¦¬å˜</option>
<option value="wide">ãƒ¯ã‚¤ãƒ‰</option>
<option value="sanrenpuku">3é€£è¤‡</option>
<option value="sanrentan">3é€£å˜</option>
</select>
</div>
<div class="form-group" id="buy-method-group">
<label style="font-size: 1.2rem; font-weight: 700; color: #333; margin-bottom: 15px; display: block;">ğŸ’³ è³¼å…¥æ–¹æ³•ã‚’é¸æŠ</label>
<div class="buy-method-options" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 20px; margin-top: 15px;">
<label class="buy-method-option" style="padding: 25px 20px; border: 4px solid #e0e0e0; border-radius: 16px; cursor: pointer; text-align: center; transition: all 0.3s; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.08); position: relative; overflow: hidden;">
<input type="radio" name="buy_method" value="normal" checked onchange="updateBuyMethod()" style="position: absolute; opacity: 0; width: 0; height: 0;">
<div class="method-check" style="position: absolute; top: 10px; right: 10px; width: 24px; height: 24px; border-radius: 50%; border: 3px solid #e0e0e0; background: white; display: flex; align-items: center; justify-content: center; transition: all 0.3s;">
<span style="display: none; color: white; font-size: 14px;">âœ“</span>
</div>
<div style="font-size: 3rem; margin-bottom: 12px; filter: grayscale(1); transition: all 0.3s;">ğŸ“‹</div>
<div style="font-weight: 700; font-size: 1.2rem; color: #333; margin-bottom: 6px;">é€šå¸¸</div>
<div style="font-size: 0.9rem; color: #999; line-height: 1.4;">1ç‚¹è²·ã„</div>
</label>
<label class="buy-method-option" id="box-option" style="padding: 25px 20px; border: 4px solid #e0e0e0; border-radius: 16px; cursor: pointer; text-align: center; transition: all 0.3s; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.08); position: relative; overflow: hidden;">
<input type="radio" name="buy_method" value="box" onchange="updateBuyMethod()" style="position: absolute; opacity: 0; width: 0; height: 0;">
<div class="method-check" style="position: absolute; top: 10px; right: 10px; width: 24px; height: 24px; border-radius: 50%; border: 3px solid #e0e0e0; background: white; display: flex; align-items: center; justify-content: center; transition: all 0.3s;">
<span style="display: none; color: white; font-size: 14px;">âœ“</span>
</div>
<div style="font-size: 3rem; margin-bottom: 12px; filter: grayscale(1); transition: all 0.3s;">ğŸ“¦</div>
<div style="font-weight: 700; font-size: 1.2rem; color: #333; margin-bottom: 6px;">ãƒœãƒƒã‚¯ã‚¹</div>
<div style="font-size: 0.9rem; color: #999; line-height: 1.4;">å…¨çµ„åˆã›</div>
</label>
<label class="buy-method-option" id="formation-option" style="padding: 25px 20px; border: 4px solid #e0e0e0; border-radius: 16px; cursor: pointer; text-align: center; transition: all 0.3s; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.08); position: relative; overflow: hidden;">
<input type="radio" name="buy_method" value="formation" onchange="updateBuyMethod()" style="position: absolute; opacity: 0; width: 0; height: 0;">
<div class="method-check" style="position: absolute; top: 10px; right: 10px; width: 24px; height: 24px; border-radius: 50%; border: 3px solid #e0e0e0; background: white; display: flex; align-items: center; justify-content: center; transition: all 0.3s;">
<span style="display: none; color: white; font-size: 14px;">âœ“</span>
</div>
<div style="font-size: 3rem; margin-bottom: 12px; filter: grayscale(1); transition: all 0.3s;">ğŸ¯</div>
<div style="font-weight: 700; font-size: 1.2rem; color: #333; margin-bottom: 6px;">ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</div>
<div style="font-size: 0.9rem; color: #999; line-height: 1.4;">è»¸æŒ‡å®š</div>
</label>
</div>
</div>

<!-- å˜å‹ãƒ»è¤‡å‹ç”¨ï¼ˆ1åˆ—ï¼‰ -->
<div id="tanfuku-input" class="bet-input-type" style="display: none;">
<div class="form-group">
<label>é¦¬ã‚’é¸æŠï¼ˆ1é ­ï¼‰</label>
<div style="overflow-x: auto;">
<table style="width: 100%; border-collapse: collapse;">
<thead>
<tr style="background: #667eea; color: white;">
<th style="padding: 10px; text-align: center;">æ </th>
<th style="padding: 10px; text-align: left;">é¦¬ç•ª</th>
<th style="padding: 10px; text-align: left;">é¦¬å</th>
<th style="padding: 10px; text-align: left;">é¨æ‰‹</th>
<th style="padding: 10px; text-align: center;">é¸æŠ</th>
</tr>
</thead>
<tbody>
<% horses.forEach(horse => { %>
<tr style="border-bottom: 1px solid #eee;">
<td style="padding: 8px; text-align: center;">
<span class="waku waku-<%= horse.waku %>" style="width: 25px; height: 25px; display: inline-block; line-height: 25px; border-radius: 3px;"><%= horse.waku %></span>
</td>
<td style="padding: 8px;"><strong><%= horse.umaban %></strong></td>
<td style="padding: 8px;"><%= horse.horse_name %></td>
<td style="padding: 8px;"><%= horse.jockey %></td>
<td style="padding: 8px; text-align: center;">
<input type="checkbox" name="tanfuku_horse" value="<%= horse.umaban %>" onchange="updateTanfukuSelection()">
</td>
</tr>
<% }); %>
</tbody>
</table>
</div>
</div>
</div>

<!-- é¦¬é€£ãƒ»ãƒ¯ã‚¤ãƒ‰ï¼šé€šå¸¸ -->
<div id="umaren-normal-input" class="bet-input-type" style="display: none;">
<div class="form-group">
<label>é¦¬ã‚’é¸æŠï¼ˆ2é ­ï¼‰</label>
<div style="overflow-x: auto;">
<table style="width: 100%; border-collapse: collapse;">
<thead>
<tr style="background: #667eea; color: white;">
<th style="padding: 10px; text-align: center;">æ </th>
<th style="padding: 10px; text-align: left;">é¦¬ç•ª</th>
<th style="padding: 10px; text-align: left;">é¦¬å</th>
<th style="padding: 10px; text-align: left;">é¨æ‰‹</th>
<th style="padding: 10px; text-align: center;">é¸æŠ</th>
</tr>
</thead>
<tbody>
<% horses.forEach(horse => { %>
<tr style="border-bottom: 1px solid #eee;">
<td style="padding: 8px; text-align: center;">
<span class="waku waku-<%= horse.waku %>" style="width: 25px; height: 25px; display: inline-block; line-height: 25px; border-radius: 3px;"><%= horse.waku %></span>
</td>
<td style="padding: 8px;"><strong><%= horse.umaban %></strong></td>
<td style="padding: 8px;"><%= horse.horse_name %></td>
<td style="padding: 8px;"><%= horse.jockey %></td>
<td style="padding: 8px; text-align: center;">
<input type="checkbox" name="umaren_normal_horse" value="<%= horse.umaban %>" onchange="updateUmarenNormalSelection()">
</td>
</tr>
<% }); %>
</tbody>
</table>
</div>
</div>
</div>

<!-- é¦¬é€£ãƒ»ãƒ¯ã‚¤ãƒ‰ï¼šãƒœãƒƒã‚¯ã‚¹ -->
<div id="umaren-box-input" class="bet-input-type" style="display: none;">
<div class="form-group">
<label>é¦¬ã‚’é¸æŠï¼ˆ2é ­ä»¥ä¸Šã§ãƒœãƒƒã‚¯ã‚¹ï¼‰</label>
<div style="overflow-x: auto;">
<table style="width: 100%; border-collapse: collapse;">
<thead>
<tr style="background: #667eea; color: white;">
<th style="padding: 10px; text-align: center;">æ </th>
<th style="padding: 10px; text-align: left;">é¦¬ç•ª</th>
<th style="padding: 10px; text-align: left;">é¦¬å</th>
<th style="padding: 10px; text-align: left;">é¨æ‰‹</th>
<th style="padding: 10px; text-align: center;">é¸æŠ</th>
</tr>
</thead>
<tbody>
<% horses.forEach(horse => { %>
<tr style="border-bottom: 1px solid #eee;">
<td style="padding: 8px; text-align: center;">
<span class="waku waku-<%= horse.waku %>" style="width: 25px; height: 25px; display: inline-block; line-height: 25px; border-radius: 3px;"><%= horse.waku %></span>
</td>
<td style="padding: 8px;"><strong><%= horse.umaban %></strong></td>
<td style="padding: 8px;"><%= horse.horse_name %></td>
<td style="padding: 8px;"><%= horse.jockey %></td>
<td style="padding: 8px; text-align: center;">
<input type="checkbox" name="umaren_box_horse" value="<%= horse.umaban %>" onchange="updateUmarenBoxSelection()">
</td>
</tr>
<% }); %>
</tbody>
</table>
</div>
<div class="selection-info"><span id="umaren-box-count">0ç‚¹</span> Ã— <span id="umaren-box-amount">100</span>å††</div>
</div>
</div>

<!-- é¦¬é€£ãƒ»ãƒ¯ã‚¤ãƒ‰ï¼šãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ -->
<div id="umaren-formation-input" class="bet-input-type" style="display: none;">
<div class="form-group">
<label>è»¸é¦¬ã¨ç›¸æ‰‹é¦¬ã‚’é¸æŠ</label>
<div style="overflow-x: auto;">
<table style="width: 100%; border-collapse: collapse;">
<thead>
<tr style="background: #667eea; color: white;">
<th style="padding: 10px; text-align: center;">æ </th>
<th style="padding: 10px; text-align: left;">é¦¬ç•ª</th>
<th style="padding: 10px; text-align: left;">é¦¬å</th>
<th style="padding: 10px; text-align: center;">è»¸é¦¬</th>
<th style="padding: 10px; text-align: center;">ç›¸æ‰‹</th>
</tr>
</thead>
<tbody>
<% horses.forEach(horse => { %>
<tr style="border-bottom: 1px solid #eee;">
<td style="padding: 8px; text-align: center;">
<span class="waku waku-<%= horse.waku %>" style="width: 25px; height: 25px; display: inline-block; line-height: 25px; border-radius: 3px;"><%= horse.waku %></span>
</td>
<td style="padding: 8px;"><strong><%= horse.umaban %></strong></td>
<td style="padding: 8px;"><%= horse.horse_name %></td>
<td style="padding: 8px; text-align: center;">
<input type="checkbox" name="umaren_form_axis" value="<%= horse.umaban %>" onchange="updateUmarenFormationSelection()">
</td>
<td style="padding: 8px; text-align: center;">
<input type="checkbox" name="umaren_form_partner" value="<%= horse.umaban %>" onchange="updateUmarenFormationSelection()">
</td>
</tr>
<% }); %>
</tbody>
</table>
</div>
<div class="selection-info"><span id="umaren-form-count">0ç‚¹</span> Ã— <span id="umaren-form-amount">100</span>å††</div>
</div>
</div>

<!-- é¦¬å˜ï¼šé€šå¸¸ -->
<div id="umatan-normal-input" class="bet-input-type" style="display: none;">
<div class="form-group">
<label>1ç€ã¨2ç€ã‚’é¸æŠ</label>
<div style="overflow-x: auto;">
<table style="width: 100%; border-collapse: collapse;">
<thead>
<tr style="background: #667eea; color: white;">
<th style="padding: 10px; text-align: center;">æ </th>
<th style="padding: 10px; text-align: left;">é¦¬ç•ª</th>
<th style="padding: 10px; text-align: left;">é¦¬å</th>
<th style="padding: 10px; text-align: center;">1ç€</th>
<th style="padding: 10px; text-align: center;">2ç€</th>
</tr>
</thead>
<tbody>
<% horses.forEach(horse => { %>
<tr style="border-bottom: 1px solid #eee;">
<td style="padding: 8px; text-align: center;">
<span class="waku waku-<%= horse.waku %>" style="width: 25px; height: 25px; display: inline-block; line-height: 25px; border-radius: 3px;"><%= horse.waku %></span>
</td>
<td style="padding: 8px;"><strong><%= horse.umaban %></strong></td>
<td style="padding: 8px;"><%= horse.horse_name %></td>
<td style="padding: 8px; text-align: center;">
<input type="checkbox" name="umatan_normal_first" value="<%= horse.umaban %>" onchange="updateUmatanNormalSelection()">
</td>
<td style="padding: 8px; text-align: center;">
<input type="checkbox" name="umatan_normal_second" value="<%= horse.umaban %>" onchange="updateUmatanNormalSelection()">
</td>
</tr>
<% }); %>
</tbody>
</table>
</div>
</div>
</div>

<!-- é¦¬å˜ï¼šãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ -->
<div id="umatan-formation-input" class="bet-input-type" style="display: none;">
<div class="form-group">
<label>1ç€å€™è£œã¨2ç€å€™è£œã‚’é¸æŠ</label>
<div style="overflow-x: auto;">
<table style="width: 100%; border-collapse: collapse;">
<thead>
<tr style="background: #667eea; color: white;">
<th style="padding: 10px; text-align: center;">æ </th>
<th style="padding: 10px; text-align: left;">é¦¬ç•ª</th>
<th style="padding: 10px; text-align: left;">é¦¬å</th>
<th style="padding: 10px; text-align: center;">1ç€å€™è£œ</th>
<th style="padding: 10px; text-align: center;">2ç€å€™è£œ</th>
</tr>
</thead>
<tbody>
<% horses.forEach(horse => { %>
<tr style="border-bottom: 1px solid #eee;">
<td style="padding: 8px; text-align: center;">
<span class="waku waku-<%= horse.waku %>" style="width: 25px; height: 25px; display: inline-block; line-height: 25px; border-radius: 3px;"><%= horse.waku %></span>
</td>
<td style="padding: 8px;"><strong><%= horse.umaban %></strong></td>
<td style="padding: 8px;"><%= horse.horse_name %></td>
<td style="padding: 8px; text-align: center;">
<input type="checkbox" name="umatan_form_first" value="<%= horse.umaban %>" onchange="updateUmatanFormationSelection()">
</td>
<td style="padding: 8px; text-align: center;">
<input type="checkbox" name="umatan_form_second" value="<%= horse.umaban %>" onchange="updateUmatanFormationSelection()">
</td>
</tr>
<% }); %>
</tbody>
</table>
</div>
<div class="selection-info"><span id="umatan-form-count">0ç‚¹</span> Ã— <span id="umatan-form-amount">100</span>å††</div>
</div>
</div>

<!-- 3é€£è¤‡ï¼šé€šå¸¸ -->
<div id="sanrenpuku-normal-input" class="bet-input-type" style="display: none;">
<div class="form-group">
<label>é¦¬ã‚’é¸æŠï¼ˆ3é ­ï¼‰</label>
<div style="overflow-x: auto;">
<table style="width: 100%; border-collapse: collapse;">
<thead>
<tr style="background: #667eea; color: white;">
<th style="padding: 10px; text-align: center;">æ </th>
<th style="padding: 10px; text-align: left;">é¦¬ç•ª</th>
<th style="padding: 10px; text-align: left;">é¦¬å</th>
<th style="padding: 10px; text-align: left;">é¨æ‰‹</th>
<th style="padding: 10px; text-align: center;">é¸æŠ</th>
</tr>
</thead>
<tbody>
<% horses.forEach(horse => { %>
<tr style="border-bottom: 1px solid #eee;">
<td style="padding: 8px; text-align: center;">
<span class="waku waku-<%= horse.waku %>" style="width: 25px; height: 25px; display: inline-block; line-height: 25px; border-radius: 3px;"><%= horse.waku %></span>
</td>
<td style="padding: 8px;"><strong><%= horse.umaban %></strong></td>
<td style="padding: 8px;"><%= horse.horse_name %></td>
<td style="padding: 8px;"><%= horse.jockey %></td>
<td style="padding: 8px; text-align: center;">
<input type="checkbox" name="sanrenpuku_normal_horse" value="<%= horse.umaban %>" onchange="updateSanrenpukuNormalSelection()">
</td>
</tr>
<% }); %>
</tbody>
</table>
</div>
</div>
</div>

<!-- 3é€£è¤‡ï¼šãƒœãƒƒã‚¯ã‚¹ -->
<div id="sanrenpuku-box-input" class="bet-input-type" style="display: none;">
<div class="form-group">
<label>é¦¬ã‚’é¸æŠï¼ˆ3é ­ä»¥ä¸Šã§ãƒœãƒƒã‚¯ã‚¹ï¼‰</label>
<div style="overflow-x: auto;">
<table style="width: 100%; border-collapse: collapse;">
<thead>
<tr style="background: #667eea; color: white;">
<th style="padding: 10px; text-align: center;">æ </th>
<th style="padding: 10px; text-align: left;">é¦¬ç•ª</th>
<th style="padding: 10px; text-align: left;">é¦¬å</th>
<th style="padding: 10px; text-align: left;">é¨æ‰‹</th>
<th style="padding: 10px; text-align: center;">é¸æŠ</th>
</tr>
</thead>
<tbody>
<% horses.forEach(horse => { %>
<tr style="border-bottom: 1px solid #eee;">
<td style="padding: 8px; text-align: center;">
<span class="waku waku-<%= horse.waku %>" style="width: 25px; height: 25px; display: inline-block; line-height: 25px; border-radius: 3px;"><%= horse.waku %></span>
</td>
<td style="padding: 8px;"><strong><%= horse.umaban %></strong></td>
<td style="padding: 8px;"><%= horse.horse_name %></td>
<td style="padding: 8px;"><%= horse.jockey %></td>
<td style="padding: 8px; text-align: center;">
<input type="checkbox" name="sanrenpuku_box_horse" value="<%= horse.umaban %>" onchange="updateSanrenpukuBoxSelection()">
</td>
</tr>
<% }); %>
</tbody>
</table>
</div>
<div class="selection-info"><span id="sanrenpuku-box-count">0ç‚¹</span> Ã— <span id="sanrenpuku-box-amount">100</span>å††</div>
</div>
</div>

<!-- 3é€£è¤‡ï¼šãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ3åˆ—ï¼‰ -->
<div id="sanrenpuku-formation-input" class="bet-input-type" style="display: none;">
<div class="form-group">
<label>1ç€å€™è£œãƒ»2ç€å€™è£œãƒ»3ç€å€™è£œã‚’é¸æŠ</label>
<div style="overflow-x: auto;">
<table style="width: 100%; border-collapse: collapse;">
<thead>
<tr style="background: #667eea; color: white;">
<th style="padding: 10px; text-align: center;">æ </th>
<th style="padding: 10px; text-align: left;">é¦¬ç•ª</th>
<th style="padding: 10px; text-align: left;">é¦¬å</th>
<th style="padding: 10px; text-align: center;">1ç€å€™è£œ</th>
<th style="padding: 10px; text-align: center;">2ç€å€™è£œ</th>
<th style="padding: 10px; text-align: center;">3ç€å€™è£œ</th>
</tr>
</thead>
<tbody>
<% horses.forEach(horse => { %>
<tr style="border-bottom: 1px solid #eee;">
<td style="padding: 8px; text-align: center;">
<span class="waku waku-<%= horse.waku %>" style="width: 25px; height: 25px; display: inline-block; line-height: 25px; border-radius: 3px;"><%= horse.waku %></span>
</td>
<td style="padding: 8px;"><strong><%= horse.umaban %></strong></td>
<td style="padding: 8px;"><%= horse.horse_name %></td>
<td style="padding: 8px; text-align: center;">
<input type="checkbox" name="sanrenpuku_form_first" value="<%= horse.umaban %>" onchange="updateSanrenpukuFormationSelection()">
</td>
<td style="padding: 8px; text-align: center;">
<input type="checkbox" name="sanrenpuku_form_second" value="<%= horse.umaban %>" onchange="updateSanrenpukuFormationSelection()">
</td>
<td style="padding: 8px; text-align: center;">
<input type="checkbox" name="sanrenpuku_form_third" value="<%= horse.umaban %>" onchange="updateSanrenpukuFormationSelection()">
</td>
</tr>
<% }); %>
</tbody>
</table>
</div>
<div class="selection-info"><span id="sanrenpuku-form-count">0ç‚¹</span> Ã— <span id="sanrenpuku-form-amount">100</span>å†† = <span id="sanrenpuku-form-total">0</span>å††</div>
</div>
</div>

<!-- 3é€£å˜ï¼šé€šå¸¸ -->
<div id="sanrentan-normal-input" class="bet-input-type" style="display: none;">
<div class="form-group">
<label>1ç€ãƒ»2ç€ãƒ»3ç€ã‚’é¸æŠ</label>
<div style="overflow-x: auto;">
<table style="width: 100%; border-collapse: collapse;">
<thead>
<tr style="background: #667eea; color: white;">
<th style="padding: 10px; text-align: center;">æ </th>
<th style="padding: 10px; text-align: left;">é¦¬ç•ª</th>
<th style="padding: 10px; text-align: left;">é¦¬å</th>
<th style="padding: 10px; text-align: center;">1ç€</th>
<th style="padding: 10px; text-align: center;">2ç€</th>
<th style="padding: 10px; text-align: center;">3ç€</th>
</tr>
</thead>
<tbody>
<% horses.forEach(horse => { %>
<tr style="border-bottom: 1px solid #eee;">
<td style="padding: 8px; text-align: center;">
<span class="waku waku-<%= horse.waku %>" style="width: 25px; height: 25px; display: inline-block; line-height: 25px; border-radius: 3px;"><%= horse.waku %></span>
</td>
<td style="padding: 8px;"><strong><%= horse.umaban %></strong></td>
<td style="padding: 8px;"><%= horse.horse_name %></td>
<td style="padding: 8px; text-align: center;">
<input type="checkbox" name="sanrentan_normal_first" value="<%= horse.umaban %>" onchange="updateSanrentanNormalSelection()">
</td>
<td style="padding: 8px; text-align: center;">
<input type="checkbox" name="sanrentan_normal_second" value="<%= horse.umaban %>" onchange="updateSanrentanNormalSelection()">
</td>
<td style="padding: 8px; text-align: center;">
<input type="checkbox" name="sanrentan_normal_third" value="<%= horse.umaban %>" onchange="updateSanrentanNormalSelection()">
</td>
</tr>
<% }); %>
</tbody>
</table>
</div>
</div>
</div>

<!-- 3é€£å˜ï¼šãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ -->
<div id="sanrentan-formation-input" class="bet-input-type" style="display: none;">
<div class="form-group">
<label>1ç€å€™è£œãƒ»2ç€å€™è£œãƒ»3ç€å€™è£œã‚’é¸æŠ</label>
<div style="overflow-x: auto;">
<table style="width: 100%; border-collapse: collapse;">
<thead>
<tr style="background: #667eea; color: white;">
<th style="padding: 10px; text-align: center;">æ </th>
<th style="padding: 10px; text-align: left;">é¦¬ç•ª</th>
<th style="padding: 10px; text-align: left;">é¦¬å</th>
<th style="padding: 10px; text-align: center;">1ç€å€™è£œ</th>
<th style="padding: 10px; text-align: center;">2ç€å€™è£œ</th>
<th style="padding: 10px; text-align: center;">3ç€å€™è£œ</th>
</tr>
</thead>
<tbody>
<% horses.forEach(horse => { %>
<tr style="border-bottom: 1px solid #eee;">
<td style="padding: 8px; text-align: center;">
<span class="waku waku-<%= horse.waku %>" style="width: 25px; height: 25px; display: inline-block; line-height: 25px; border-radius: 3px;"><%= horse.waku %></span>
</td>
<td style="padding: 8px;"><strong><%= horse.umaban %></strong></td>
<td style="padding: 8px;"><%= horse.horse_name %></td>
<td style="padding: 8px; text-align: center;">
<input type="checkbox" name="sanrentan_form_first" value="<%= horse.umaban %>" onchange="updateSanrentanFormationSelection()">
</td>
<td style="padding: 8px; text-align: center;">
<input type="checkbox" name="sanrentan_form_second" value="<%= horse.umaban %>" onchange="updateSanrentanFormationSelection()">
</td>
<td style="padding: 8px; text-align: center;">
<input type="checkbox" name="sanrentan_form_third" value="<%= horse.umaban %>" onchange="updateSanrentanFormationSelection()">
</td>
</tr>
<% }); %>
</tbody>
</table>
</div>
<div class="selection-info"><span id="sanrentan-form-count">0ç‚¹</span> Ã— <span id="sanrentan-form-amount">100</span>å†† = <span id="sanrentan-form-total">0</span>å††</div>
</div>
</div>

<input type="hidden" id="horses_input" name="horses">
<input type="hidden" id="buy_method_input" name="buy_method" value="normal">
<input type="hidden" id="bet_count" value="0">
<div class="form-group">
<label for="amount">1ç‚¹ã‚ãŸã‚Šé‡‘é¡ï¼ˆå††ï¼‰</label>
<input type="number" id="amount" name="amount" min="100" step="100" value="100" required>
</div>
<button type="submit" class="btn">é¦¬åˆ¸ã‚’è¿½åŠ </button>
</form>
</div>
<div class="section">
<%
// ç™ºèµ°æ™‚åˆ»ã‚’ãƒã‚§ãƒƒã‚¯
const now = new Date();
const raceDateTime = new Date(race.race_date);
const [hours, minutes] = race.race_time.split(':');
raceDateTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
const isTestMode = process.env.TEST_MODE === 'true';
const canDeleteBets = isTestMode || (now < raceDateTime);
%>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h2 style="margin: 0;">ğŸ« è³¼å…¥æ¸ˆã¿é¦¬åˆ¸</h2>
<% if (bets.length > 0 && canDeleteBets) { %>
<button onclick="deleteAllMyBets()" class="btn btn-danger" style="padding: 8px 16px; font-size: 14px;">ğŸ—‘ï¸ å…¨ã¦å‰Šé™¤</button>
<% } %>
</div>
<ul class="bet-list">
<% if (bets.length === 0) { %>
<p style="color: #888;">ã¾ã é¦¬åˆ¸ã‚’è³¼å…¥ã—ã¦ã„ã¾ã›ã‚“</p>
<% } else { %>
<% 
const betTypeNames = { 'tansho': 'å˜å‹', 'fukusho': 'è¤‡å‹', 'umaren': 'é¦¬é€£', 'umatan': 'é¦¬å˜', 'wide': 'ãƒ¯ã‚¤ãƒ‰', 'sanrenpuku': '3é€£è¤‡', 'sanrentan': '3é€£å˜' };
// é¦¬åˆ¸ç¨®åˆ¥ã®é †åº
const betTypeOrder = { 'tansho': 1, 'fukusho': 2, 'umaren': 3, 'wide': 4, 'sanrenpuku': 5, 'sanrentan': 6 };
// ã‚½ãƒ¼ãƒˆ
const sortedBets = bets.sort((a, b) => {
    return (betTypeOrder[a.bet_type] || 99) - (betTypeOrder[b.bet_type] || 99);
});
let totalAmount = 0;
%>
<% sortedBets.forEach(bet => { 
    totalAmount += bet.amount; 
    const betFormat = bet.bet_format || 'single';
    
    // è¡¨ç¤ºç”¨ã®é¦¬ç•ªæ–‡å­—åˆ—ã‚’ç”Ÿæˆ
    let horsesDisplay = '';
    if (betFormat === 'box') {
        horsesDisplay = '<span style="background: #fff3cd; padding: 3px 10px; border-radius: 4px; font-weight: bold; font-size: 0.85rem; margin-right: 8px; border: 1px solid #ffc107;">BOX</span>' + bet.horses.replace(/,/g, ', ');
    } else if (betFormat === 'formation') {
        horsesDisplay = '<span style="background: #d1ecf1; padding: 3px 10px; border-radius: 4px; font-weight: bold; font-size: 0.85rem; margin-right: 8px; border: 1px solid #17a2b8;">ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</span>' + bet.horses.replace(/>/g, ' <span style="color: #667eea; font-weight: bold;">â–¶</span> ').replace(/,/g, ', ');
    } else {
        horsesDisplay = bet.horses.replace(/,/g, ' - ');
    }
%>
<li class="bet-item">
<div class="bet-info"><strong><%= betTypeNames[bet.bet_type] %></strong>: <%- horsesDisplay %> - <%= bet.amount.toLocaleString() %>å††</div>
<% if (canDeleteBets) { %>
<button class="btn btn-danger" onclick="deleteBet(<%= bet.id %>)">å‰Šé™¤</button>
<% } %>
</li>
<% }); %>
<div class="total-amount">åˆè¨ˆ: <span id="total-amount"><%= totalAmount.toLocaleString() %></span>å††</div>
<div class="remaining-amount">æ®‹ã‚Š: <%= (10000 - totalAmount).toLocaleString() %>å††</div>
<% } %>
</ul>
</div>
</div>
<script>
// è³¼å…¥æ–¹æ³•ã¨é¦¬åˆ¸ç¨®åˆ¥ã«ã‚ˆã‚‹UIåˆ‡ã‚Šæ›¿ãˆ
function updateBuyMethod() {
    const betType = document.getElementById('bet_type').value;
    const buyMethod = document.querySelector('input[name="buy_method"]:checked').value;
    
    // è³¼å…¥æ–¹æ³•ã®é¸æŠçŠ¶æ…‹ã‚’è¦–è¦šçš„ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    document.querySelectorAll('.buy-method-option').forEach(label => {
        const radio = label.querySelector('input[type="radio"]');
        const checkmark = label.querySelector('.method-check');
        const checkSpan = checkmark.querySelector('span');
        const icon = label.querySelector('div[style*="font-size: 3rem"]');
        
        if (radio && radio.checked) {
            // é¸æŠçŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ«
            label.style.borderColor = '#667eea';
            label.style.background = 'linear-gradient(135deg, #e8f0fe 0%, #f3e7f9 100%)';
            label.style.transform = 'translateY(-4px) scale(1.02)';
            label.style.boxShadow = '0 12px 24px rgba(102, 126, 234, 0.25)';
            
            // ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’è¡¨ç¤º
            checkmark.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            checkmark.style.borderColor = '#667eea';
            checkSpan.style.display = 'block';
            
            // ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚«ãƒ©ãƒ•ãƒ«ã«
            icon.style.filter = 'grayscale(0)';
            icon.style.transform = 'scale(1.1)';
            
        } else {
            // éé¸æŠçŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ«
            label.style.borderColor = '#e0e0e0';
            label.style.background = 'white';
            label.style.transform = 'translateY(0) scale(1)';
            label.style.boxShadow = '0 4px 12px rgba(0,0,0,0.08)';
            
            // ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’éè¡¨ç¤º
            checkmark.style.background = 'white';
            checkmark.style.borderColor = '#e0e0e0';
            checkSpan.style.display = 'none';
            
            // ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ã«
            icon.style.filter = 'grayscale(1)';
            icon.style.transform = 'scale(1)';
        }
    });
    
    // å…¨ã¦ã®å…¥åŠ›ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
    document.querySelectorAll('.bet-input-type').forEach(el => el.style.display = 'none');
    
    // ãƒã‚§ãƒƒã‚¯ã‚’å…¨ã¦ãƒªã‚»ãƒƒãƒˆ
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        if (!cb.name.startsWith('mark_')) cb.checked = false;
    });
    document.querySelectorAll('.horse-checkbox-label, .horse-checkbox-label-small').forEach(label => {
        label.classList.remove('selected');
    });
    
    // éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
    document.getElementById('buy_method_input').value = buyMethod;
    
    // å¯¾å¿œã™ã‚‹å…¥åŠ›ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
    if (betType === 'tansho' || betType === 'fukusho') {
        document.getElementById('tanfuku-input').style.display = 'block';
    } else if (betType === 'umaren' || betType === 'wide') {
        if (buyMethod === 'normal') {
            document.getElementById('umaren-normal-input').style.display = 'block';
        } else if (buyMethod === 'box') {
            document.getElementById('umaren-box-input').style.display = 'block';
        } else if (buyMethod === 'formation') {
            document.getElementById('umaren-formation-input').style.display = 'block';
        }
    } else if (betType === 'umatan') {
        if (buyMethod === 'normal') {
            document.getElementById('umatan-normal-input').style.display = 'block';
        } else if (buyMethod === 'formation') {
            document.getElementById('umatan-formation-input').style.display = 'block';
        }
    } else if (betType === 'sanrenpuku') {
        if (buyMethod === 'normal') {
            document.getElementById('sanrenpuku-normal-input').style.display = 'block';
        } else if (buyMethod === 'box') {
            document.getElementById('sanrenpuku-box-input').style.display = 'block';
        } else if (buyMethod === 'formation') {
            document.getElementById('sanrenpuku-formation-input').style.display = 'block';
        }
    } else if (betType === 'sanrentan') {
        if (buyMethod === 'normal') {
            document.getElementById('sanrentan-normal-input').style.display = 'block';
        } else if (buyMethod === 'formation') {
            document.getElementById('sanrentan-formation-input').style.display = 'block';
        }
    }
    
    // è³¼å…¥æ–¹æ³•ã®é¸æŠè‚¢ã‚’æ›´æ–°
    updateBuyMethodOptions();
}

// é¦¬åˆ¸ç¨®åˆ¥ã«ã‚ˆã‚‹è³¼å…¥æ–¹æ³•é¸æŠè‚¢ã®è¡¨ç¤ºåˆ¶å¾¡
function updateBuyMethodOptions() {
    const betType = document.getElementById('bet_type').value;
    const isTanFuku = betType === 'tansho' || betType === 'fukusho';
    const is2ren = betType === 'umaren' || betType === 'wide';
    const isUmatan = betType === 'umatan';
    const is3renpuku = betType === 'sanrenpuku';
    const is3rentan = betType === 'sanrentan';
    
    // ãƒœãƒƒã‚¯ã‚¹ã¨ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
    document.getElementById('box-option').style.display = (is2ren || is3renpuku) ? 'flex' : 'none';
    document.getElementById('formation-option').style.display = (is2ren || isUmatan || is3renpuku || is3rentan) ? 'flex' : 'none';
    
    // å˜å‹ãƒ»è¤‡å‹ã®å ´åˆã¯é€šå¸¸ã®ã¿
    if (isTanFuku) {
        document.querySelector('input[name="buy_method"][value="normal"]').checked = true;
    }
}

// é¦¬åˆ¸ç¨®åˆ¥å¤‰æ›´æ™‚
document.getElementById('bet_type').addEventListener('change', function() {
    updateBuyMethodOptions();
    document.querySelector('input[name="buy_method"][value="normal"]').checked = true;
    updateBuyMethod();
});

// ãƒ©ãƒ™ãƒ«ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆå‡¦ç†ï¼ˆå…±é€šé–¢æ•°ï¼‰
function highlightLabels(checkboxes, labelClass) {
    checkboxes.forEach(cb => {
        const label = cb.closest('.' + labelClass);
        if (label) {
            if (cb.checked) label.classList.add('selected');
            else label.classList.remove('selected');
        }
    });
}

// å˜å‹ãƒ»è¤‡å‹ã®é¸æŠå‡¦ç†
function updateTanfukuSelection() {
    const checkboxes = document.querySelectorAll('input[name="tanfuku_horse"]');
    const checked = Array.from(checkboxes).filter(cb => cb.checked);
    
    // 1é ­ã®ã¿é¸æŠå¯èƒ½
    if (checked.length > 1) {
        checked[0].checked = false;
    }
    
    highlightLabels(checkboxes, 'horse-checkbox-label');
    
    const selected = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
    document.getElementById('horses_input').value = selected.join(',');
    document.getElementById('bet_count').value = selected.length;
}

// é¦¬é€£ãƒ»ãƒ¯ã‚¤ãƒ‰ï¼šé€šå¸¸
function updateUmarenNormalSelection() {
    const checkboxes = document.querySelectorAll('input[name="umaren_normal_horse"]');
    const checked = Array.from(checkboxes).filter(cb => cb.checked);
    
    // 2é ­ã®ã¿
    if (checked.length > 2) {
        checked[0].checked = false;
    }
    
    highlightLabels(checkboxes, 'horse-checkbox-label');
    
    const selected = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
    document.getElementById('horses_input').value = selected.join(',');
    document.getElementById('bet_count').value = selected.length === 2 ? 1 : 0;
}

// é¦¬é€£ãƒ»ãƒ¯ã‚¤ãƒ‰ï¼šãƒœãƒƒã‚¯ã‚¹
function updateUmarenBoxSelection() {
    const checkboxes = document.querySelectorAll('input[name="umaren_box_horse"]');
    const checked = Array.from(checkboxes).filter(cb => cb.checked);
    const n = checked.length;
    const count = n >= 2 ? (n * (n - 1)) / 2 : 0;
    
    highlightLabels(checkboxes, 'horse-checkbox-label');
    
    document.getElementById('horses_input').value = checked.map(cb => cb.value).join(',');
    document.getElementById('bet_count').value = count;
    document.getElementById('umaren-box-count').textContent = count + 'ç‚¹';
    const amount = parseInt(document.getElementById('amount').value) || 100;
    document.getElementById('umaren-box-amount').textContent = amount;
}

// é¦¬é€£ãƒ»ãƒ¯ã‚¤ãƒ‰ï¼šãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆè»¸é¦¬-ç›¸æ‰‹é¦¬ï¼‰
function updateUmarenFormationSelection() {
    const axis = Array.from(document.querySelectorAll('input[name="umaren_form_axis"]:checked'));
    const partners = Array.from(document.querySelectorAll('input[name="umaren_form_partner"]:checked'));
    
    // è»¸é¦¬Ã—ç›¸æ‰‹é¦¬ã®çµ„ã¿åˆã‚ã›ã®ã¿ï¼ˆè»¸é¦¬åŒå£«ã¯é™¤å¤–ï¼‰
    let count = 0;
    const combinations = new Set();
    
    // è»¸é¦¬Ã—ç›¸æ‰‹é¦¬
    axis.forEach(a => {
        partners.forEach(p => {
            if (a.value !== p.value) {
                const sorted = [a.value, p.value].sort((a, b) => parseInt(a) - parseInt(b)).join(',');
                combinations.add(sorted);
            }
        });
    });
    
    count = combinations.size;
    
    document.getElementById('horses_input').value = axis.map(a => a.value).join(',') + '-' + partners.map(p => p.value).join(',');
    document.getElementById('bet_count').value = count;
    document.getElementById('umaren-form-count').textContent = count + 'ç‚¹';
    const amount = parseInt(document.getElementById('amount').value) || 100;
    document.getElementById('umaren-form-amount').textContent = amount;
}

// é¦¬å˜ï¼šé€šå¸¸
function updateUmatanNormalSelection() {
    const first = document.querySelectorAll('input[name="umatan_normal_first"]');
    const second = document.querySelectorAll('input[name="umatan_normal_second"]');
    const firstChecked = Array.from(first).filter(cb => cb.checked);
    const secondChecked = Array.from(second).filter(cb => cb.checked);
    
    // å„1é ­ã®ã¿
    if (firstChecked.length > 1) firstChecked[0].checked = false;
    if (secondChecked.length > 1) secondChecked[0].checked = false;
    
    highlightLabels(first, 'horse-checkbox-label');
    highlightLabels(second, 'horse-checkbox-label');
    
    const firstVals = Array.from(first).filter(cb => cb.checked).map(cb => cb.value);
    const secondVals = Array.from(second).filter(cb => cb.checked).map(cb => cb.value);
    
    const count = (firstVals.length === 1 && secondVals.length === 1 && firstVals[0] !== secondVals[0]) ? 1 : 0;
    
    document.getElementById('horses_input').value = firstVals.join(',') + '-' + secondVals.join(',');
    document.getElementById('bet_count').value = count;
}

// é¦¬å˜ï¼šãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
function updateUmatanFormationSelection() {
    const first = Array.from(document.querySelectorAll('input[name="umatan_form_first"]:checked'));
    const second = Array.from(document.querySelectorAll('input[name="umatan_form_second"]:checked'));
    
    let count = 0;
    first.forEach(f => {
        second.forEach(s => {
            if (f.value !== s.value) count++;
        });
    });
    
    highlightLabels(document.querySelectorAll('input[name="umatan_form_first"]'), 'horse-checkbox-label');
    highlightLabels(document.querySelectorAll('input[name="umatan_form_second"]'), 'horse-checkbox-label');
    
    document.getElementById('horses_input').value = first.map(f => f.value).join(',') + '-' + second.map(s => s.value).join(',');
    document.getElementById('bet_count').value = count;
    document.getElementById('umatan-form-count').textContent = count + 'ç‚¹';
    const amount = parseInt(document.getElementById('amount').value) || 100;
    document.getElementById('umatan-form-amount').textContent = amount;
}

// 3é€£è¤‡ï¼šé€šå¸¸
function updateSanrenpukuNormalSelection() {
    const checkboxes = document.querySelectorAll('input[name="sanrenpuku_normal_horse"]');
    const checked = Array.from(checkboxes).filter(cb => cb.checked);
    
    // 3é ­ã®ã¿
    if (checked.length > 3) {
        checked[0].checked = false;
    }
    
    highlightLabels(checkboxes, 'horse-checkbox-label');
    
    const selected = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
    document.getElementById('horses_input').value = selected.join(',');
    document.getElementById('bet_count').value = selected.length === 3 ? 1 : 0;
}

// 3é€£è¤‡ï¼šãƒœãƒƒã‚¯ã‚¹
function updateSanrenpukuBoxSelection() {
    const checkboxes = document.querySelectorAll('input[name="sanrenpuku_box_horse"]');
    const checked = Array.from(checkboxes).filter(cb => cb.checked);
    const n = checked.length;
    const count = n >= 3 ? (n * (n - 1) * (n - 2)) / 6 : 0;
    
    highlightLabels(checkboxes, 'horse-checkbox-label');
    
    document.getElementById('horses_input').value = checked.map(cb => cb.value).join(',');
    document.getElementById('bet_count').value = count;
    document.getElementById('sanrenpuku-box-count').textContent = count + 'ç‚¹';
    const amount = parseInt(document.getElementById('amount').value) || 100;
    document.getElementById('sanrenpuku-box-amount').textContent = amount;
}

// 3é€£è¤‡ï¼šãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ3åˆ—ãã‚Œãã‚Œã‹ã‚‰é¸ã‚“ã§çµ„ã¿åˆã‚ã›ï¼‰
function updateSanrenpukuFormationSelection() {
    const first = Array.from(document.querySelectorAll('input[name="sanrenpuku_form_first"]:checked'));
    const second = Array.from(document.querySelectorAll('input[name="sanrenpuku_form_second"]:checked'));
    const third = Array.from(document.querySelectorAll('input[name="sanrenpuku_form_third"]:checked'));
    
    // 3é€£è¤‡ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼šå„åˆ—ã‹ã‚‰1é ­ãšã¤é¸ã³ã€é‡è¤‡ã‚’é™¤ã„ãŸçµ„ã¿åˆã‚ã›ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
    let count = 0;
    const combinations = new Set();
    
    first.forEach(f => {
        second.forEach(s => {
            third.forEach(t => {
                const vals = [f.value, s.value, t.value];
                // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                if (new Set(vals).size === 3) {
                    // 3é€£è¤‡ã¯é †åºé–¢ä¿‚ãªã—ã€ã‚½ãƒ¼ãƒˆã—ã¦ä¸€æ„ã«ã™ã‚‹
                    const sorted = vals.sort((a, b) => a - b).join('-');
                    combinations.add(sorted);
                }
            });
        });
    });
    
    count = combinations.size;
    
    highlightLabels(document.querySelectorAll('input[name="sanrenpuku_form_first"]'), 'horse-checkbox-label-small');
    highlightLabels(document.querySelectorAll('input[name="sanrenpuku_form_second"]'), 'horse-checkbox-label-small');
    highlightLabels(document.querySelectorAll('input[name="sanrenpuku_form_third"]'), 'horse-checkbox-label-small');
    
    document.getElementById('horses_input').value = 
        first.map(f => f.value).join(',') + '-' + 
        second.map(s => s.value).join(',') + '-' + 
        third.map(t => t.value).join(',');
    document.getElementById('bet_count').value = count;
    document.getElementById('sanrenpuku-form-count').textContent = count + 'ç‚¹';
    const amount = parseInt(document.getElementById('amount').value) || 100;
    document.getElementById('sanrenpuku-form-amount').textContent = amount;
    document.getElementById('sanrenpuku-form-total').textContent = (count * amount).toLocaleString();
}

// 3é€£å˜ï¼šé€šå¸¸
function updateSanrentanNormalSelection() {
    const first = document.querySelectorAll('input[name="sanrentan_normal_first"]');
    const second = document.querySelectorAll('input[name="sanrentan_normal_second"]');
    const third = document.querySelectorAll('input[name="sanrentan_normal_third"]');
    
    const firstChecked = Array.from(first).filter(cb => cb.checked);
    const secondChecked = Array.from(second).filter(cb => cb.checked);
    const thirdChecked = Array.from(third).filter(cb => cb.checked);
    
    // å„1é ­ã®ã¿
    if (firstChecked.length > 1) firstChecked[0].checked = false;
    if (secondChecked.length > 1) secondChecked[0].checked = false;
    if (thirdChecked.length > 1) thirdChecked[0].checked = false;
    
    highlightLabels(first, 'horse-checkbox-label-small');
    highlightLabels(second, 'horse-checkbox-label-small');
    highlightLabels(third, 'horse-checkbox-label-small');
    
    const firstVals = Array.from(first).filter(cb => cb.checked).map(cb => cb.value);
    const secondVals = Array.from(second).filter(cb => cb.checked).map(cb => cb.value);
    const thirdVals = Array.from(third).filter(cb => cb.checked).map(cb => cb.value);
    
    const vals = [...firstVals, ...secondVals, ...thirdVals];
    const count = (new Set(vals).size === 3 && vals.length === 3) ? 1 : 0;
    
    document.getElementById('horses_input').value = firstVals.join(',') + '-' + secondVals.join(',') + '-' + thirdVals.join(',');
    document.getElementById('bet_count').value = count;
}

// 3é€£å˜ï¼šãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
function updateSanrentanFormationSelection() {
    const first = Array.from(document.querySelectorAll('input[name="sanrentan_form_first"]:checked'));
    const second = Array.from(document.querySelectorAll('input[name="sanrentan_form_second"]:checked'));
    const third = Array.from(document.querySelectorAll('input[name="sanrentan_form_third"]:checked'));
    
    // 3é€£å˜ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼šé‡è¤‡ã‚’é™¤ã„ãŸçµ„ã¿åˆã‚ã›æ•°
    let count = 0;
    first.forEach(f => {
        second.forEach(s => {
            if (f.value !== s.value) {
                third.forEach(t => {
                    if (t.value !== f.value && t.value !== s.value) {
                        count++;
                    }
                });
            }
        });
    });
    
    highlightLabels(document.querySelectorAll('input[name="sanrentan_form_first"]'), 'horse-checkbox-label-small');
    highlightLabels(document.querySelectorAll('input[name="sanrentan_form_second"]'), 'horse-checkbox-label-small');
    highlightLabels(document.querySelectorAll('input[name="sanrentan_form_third"]'), 'horse-checkbox-label-small');
    
    document.getElementById('horses_input').value = 
        first.map(f => f.value).join(',') + '-' + 
        second.map(s => s.value).join(',') + '-' + 
        third.map(t => t.value).join(',');
    document.getElementById('bet_count').value = count;
    document.getElementById('sanrentan-form-count').textContent = count + 'ç‚¹';
    const amount = parseInt(document.getElementById('amount').value) || 100;
    document.getElementById('sanrentan-form-amount').textContent = amount;
    document.getElementById('sanrentan-form-total').textContent = (count * amount).toLocaleString();
}

// é‡‘é¡å¤‰æ›´æ™‚ã®å†è¨ˆç®—
document.getElementById('amount').addEventListener('input', function() {
    const betType = document.getElementById('bet_type').value;
    const buyMethod = document.querySelector('input[name="buy_method"]:checked').value;
    
    if (buyMethod === 'box' && (betType === 'umaren' || betType === 'wide')) {
        updateUmarenBoxSelection();
    } else if (buyMethod === 'formation' && (betType === 'umaren' || betType === 'wide')) {
        updateUmarenFormationSelection();
    } else if (buyMethod === 'formation' && betType === 'umatan') {
        updateUmatanFormationSelection();
    } else if (buyMethod === 'box' && betType === 'sanrenpuku') {
        updateSanrenpukuBoxSelection();
    } else if (buyMethod === 'formation' && betType === 'sanrenpuku') {
        updateSanrenpukuFormationSelection();
    } else if (buyMethod === 'formation' && betType === 'sanrentan') {
        updateSanrentanFormationSelection();
    }
});

// åˆæœŸè¡¨ç¤º
document.getElementById('tanfuku-input').style.display = 'block';
updateBuyMethodOptions();

// å°ã®é¸æŠåˆ¶å¾¡ï¼ˆåŒã˜å°ã¯1é ­ã®ã¿ã€æœ€å¤§5é ­ã¾ã§ï¼‰
document.querySelectorAll('.mark-select').forEach(select => {
    select.addEventListener('change', function() {
        const selectedMark = this.value;
        const currentUmaban = this.name.replace('mark_', '');
        
        if (selectedMark) {
            // åŒã˜å°ãŒä»–ã®é¦¬ã«æ—¢ã«é¸æŠã•ã‚Œã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
            document.querySelectorAll('.mark-select').forEach(otherSelect => {
                const otherUmaban = otherSelect.name.replace('mark_', '');
                if (otherUmaban !== currentUmaban && otherSelect.value === selectedMark) {
                    // ä»–ã®é¦¬ã‹ã‚‰åŒã˜å°ã‚’è§£é™¤
                    otherSelect.value = '';
                }
            });
        }
        
        // é¸æŠæ¸ˆã¿å°æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼ˆæœ€å¤§5å€‹ãƒã‚§ãƒƒã‚¯ï¼‰
        const selectedCount = Array.from(document.querySelectorAll('.mark-select')).filter(s => s.value).length;
        
        // æœªé¸æŠã®è¦ç´ ã¯5å€‹ã¾ã§é¸æŠå¯èƒ½
        document.querySelectorAll('.mark-select').forEach(s => {
            if (!s.value && selectedCount >= 5) {
                // 5å€‹é¸æŠæ¸ˆã¿ã®å ´åˆã€æœªé¸æŠã®è¦ç´ ã‚’ç„¡åŠ¹åŒ–
                Array.from(s.options).forEach(opt => {
                    if (opt.value) opt.disabled = true;
                });
            } else if (!s.value) {
                // 5å€‹æœªæº€ã®å ´åˆã€ã™ã¹ã¦æœ‰åŠ¹åŒ–
                Array.from(s.options).forEach(opt => opt.disabled = false);
            }
        });
    });
});

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸãƒã‚§ãƒƒã‚¯
window.addEventListener('DOMContentLoaded', () => {
    const selectedCount = Array.from(document.querySelectorAll('.mark-select')).filter(s => s.value).length;
    if (selectedCount >= 5) {
        document.querySelectorAll('.mark-select').forEach(s => {
            if (!s.value) {
                Array.from(s.options).forEach(opt => {
                    if (opt.value) opt.disabled = true;
                });
            }
        });
    }
    
    // ã‚³ãƒ¡ãƒ³ãƒˆæ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆ
    const commentTextarea = document.getElementById('prediction_comment');
    const commentCount = document.getElementById('comment_count');
    if (commentTextarea && commentCount) {
        // åˆæœŸè¡¨ç¤º
        commentCount.textContent = commentTextarea.value.length;
        
        // å…¥åŠ›æ™‚ã®æ›´æ–°
        commentTextarea.addEventListener('input', function() {
            commentCount.textContent = this.value.length;
        });
    }
});

// å°ã®ä¿å­˜
document.getElementById('marks-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const marks = {};
    for (const [key, value] of formData.entries()) {
        if (key.startsWith('mark_') && value) {
            marks[key.replace('mark_', '')] = value;
        }
    }
    const comment = document.getElementById('prediction_comment').value;
    try {
        const r = await fetch('/predictions/<%= race.race_id %>/marks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ marks, comment })
        });
        alert(r.ok ? 'å°ã‚’ä¿å­˜ã—ã¾ã—ãŸ' : 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        if (r.ok) location.reload();
    } catch (error) { alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'); }
});

// é¦¬åˆ¸ã®è¿½åŠ 
document.getElementById('bet-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const betType = document.getElementById('bet_type').value;
    const buyMethod = document.getElementById('buy_method_input').value;
    const horses = document.getElementById('horses_input').value;
    const betCount = parseInt(document.getElementById('bet_count').value) || 0;
    const amount = parseInt(document.getElementById('amount').value) || 100;

    if (!horses || betCount === 0) {
        alert('é¦¬ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }

    const data = {
        bet_type: betType,
        horses: horses,
        amount: amount,
        buy_method: buyMethod,
        bet_count: betCount
    };
    
    // ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è²·ã„ã®å ´åˆã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
    if (buyMethod === 'formation') {
        if (betType === 'umaren') {
            // é¦¬é€£ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: è»¸é¦¬ã¨ç›¸æ‰‹é¦¬
            const axisVals = Array.from(document.querySelectorAll('input[name="umaren_form_axis"]:checked')).map(cb => cb.value);
            const partnerVals = Array.from(document.querySelectorAll('input[name="umaren_form_partner"]:checked')).map(cb => cb.value);
            data.axis_horses = axisVals.join(',');
            data.partner_horses = partnerVals.join(',');
        } else if (betType === 'umatan') {
            // é¦¬å˜ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: 1ç€å€™è£œã¨2ç€å€™è£œ
            const firstVals = Array.from(document.querySelectorAll('input[name="umatan_form_first"]:checked')).map(cb => cb.value);
            const secondVals = Array.from(document.querySelectorAll('input[name="umatan_form_second"]:checked')).map(cb => cb.value);
            data.first = firstVals.join(',');
            data.second = secondVals.join(',');
        } else if (betType === 'sanrenpuku') {
            // 3é€£è¤‡ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: 1ç€ãƒ»2ç€ãƒ»3ç€å€™è£œ
            const firstVals = Array.from(document.querySelectorAll('input[name="sanrenpuku_form_first"]:checked')).map(cb => cb.value);
            const secondVals = Array.from(document.querySelectorAll('input[name="sanrenpuku_form_second"]:checked')).map(cb => cb.value);
            const thirdVals = Array.from(document.querySelectorAll('input[name="sanrenpuku_form_third"]:checked')).map(cb => cb.value);
            data.first = firstVals.join(',');
            data.second = secondVals.join(',');
            data.third = thirdVals.join(',');
        } else if (betType === 'sanrentan') {
            // 3é€£å˜ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: 1ç€ãƒ»2ç€ãƒ»3ç€å€™è£œ
            const firstVals = Array.from(document.querySelectorAll('input[name="sanrentan_form_first"]:checked')).map(cb => cb.value);
            const secondVals = Array.from(document.querySelectorAll('input[name="sanrentan_form_second"]:checked')).map(cb => cb.value);
            const thirdVals = Array.from(document.querySelectorAll('input[name="sanrentan_form_third"]:checked')).map(cb => cb.value);
            data.first = firstVals.join(',');
            data.second = secondVals.join(',');
            data.third = thirdVals.join(',');
        }
    }

    try {
        const r = await fetch('/predictions/<%= race.race_id %>/bets', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await r.json();
        if (r.ok) {
            alert(`é¦¬åˆ¸ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆ${betCount}ç‚¹ Ã— ${amount}å†† = ${(betCount * amount).toLocaleString()}å††ï¼‰`);
            location.reload();
        } else {
            alert(result.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        }
    } catch (error) { 
        console.error(error);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'); 
    }
});

// é¦¬åˆ¸ã®å‰Šé™¤
async function deleteBet(betId) {
    if (!confirm('ã“ã®é¦¬åˆ¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    try {
        const r = await fetch(`/predictions/<%= race.race_id %>/bets/${betId}`, { method: 'DELETE' });
        if (r.ok) { 
            alert('é¦¬åˆ¸ã‚’å‰Šé™¤ã—ã¾ã—ãŸ'); 
            location.reload(); 
        } else { 
            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'); 
        }
    } catch (error) { 
        console.error(error);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'); 
    }
}

// ãŠã¾ã‹ã›è³¼å…¥
async function autoBet() {
    // ç¾åœ¨ã®å°ã®é¸æŠçŠ¶æ³ã‚’ç¢ºèª
    const marks = {};
    document.querySelectorAll('.mark-select').forEach(select => {
        const umaban = select.name.replace('mark_', '');
        const mark = select.value;
        if (mark) {
            marks[umaban] = mark;
        }
    });
    
    const markCount = Object.keys(marks).length;
    
    if (markCount === 0) {
        alert('å…ˆã«äºˆæƒ³å°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    // è³¼å…¥ãƒ‘ã‚¿ãƒ¼ãƒ³ã®èª¬æ˜
    let message = 'ãŠã¾ã‹ã›è³¼å…¥ã‚’å®Ÿè¡Œã—ã¾ã™\n\n';
    if (markCount === 1) {
        message += 'ã€è³¼å…¥å†…å®¹ã€‘\nãƒ»å˜å‹ 10,000å††Ã—1ç‚¹\nåˆè¨ˆ: 10,000å††';
    } else if (markCount === 2) {
        message += 'ã€è³¼å…¥å†…å®¹ã€‘\nãƒ»å˜å‹ 5,000å††Ã—1ç‚¹\nãƒ»é¦¬é€£ 5,000å††Ã—1ç‚¹\nåˆè¨ˆ: 10,000å††';
    } else if (markCount === 3) {
        message += 'ã€è³¼å…¥å†…å®¹ã€‘\nãƒ»å˜å‹ 3,000å††Ã—1ç‚¹\nãƒ»é¦¬é€£ãƒœãƒƒã‚¯ã‚¹ 2,000å††Ã—3ç‚¹\nãƒ»3é€£è¤‡ 1,000å††Ã—1ç‚¹\nåˆè¨ˆ: 10,000å††';
    } else if (markCount === 4) {
        message += 'ã€è³¼å…¥å†…å®¹ã€‘\nãƒ»å˜å‹ 2,000å††Ã—1ç‚¹\nãƒ»é¦¬é€£ãƒœãƒƒã‚¯ã‚¹ï¼ˆä¸Šä½3é ­ï¼‰2,000å††Ã—3ç‚¹\nãƒ»3é€£è¤‡ãƒœãƒƒã‚¯ã‚¹ 500å††Ã—4ç‚¹\nåˆè¨ˆ: 10,000å††';
    } else if (markCount === 5) {
        message += 'ã€è³¼å…¥å†…å®¹ã€‘\nãƒ»å˜å‹ 2,000å††Ã—1ç‚¹\nãƒ»é¦¬é€£ãƒœãƒƒã‚¯ã‚¹ï¼ˆä¸Šä½3é ­ï¼‰1,000å††Ã—3ç‚¹\nãƒ»3é€£è¤‡ãƒœãƒƒã‚¯ã‚¹ 500å††Ã—10ç‚¹\nåˆè¨ˆ: 10,000å††';
    }
    
    message += '\n\nâ€»æ—¢å­˜ã®é¦¬åˆ¸ãŒã‚ã‚‹å ´åˆã¯å®Ÿè¡Œã§ãã¾ã›ã‚“';
    
    if (!confirm(message)) return;
    
    try {
        const r = await fetch('/predictions/<%= race.race_id %>/auto-bet', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });
        const result = await r.json();
        if (r.ok) {
            alert(result.message);
            location.reload();
        } else {
            alert(result.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        }
    } catch (error) { 
        console.error(error);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'); 
    }
}

// é¦¬åˆ¸ã‚’å…¨ã¦å‰Šé™¤
async function deleteAllMyBets() {
    const raceId = '<%= race.race_id %>';
    
    if (!confirm('ã“ã®ãƒ¬ãƒ¼ã‚¹ã®è³¼å…¥é¦¬åˆ¸ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        return;
    }
    
    try {
        const r = await fetch(`/races/${raceId}/delete-my-bets`, {
            method: 'POST'
        });
        
        const text = await r.text();
        
        if (r.ok) {
            alert(text);
            location.reload();
        } else {
            alert('ã‚¨ãƒ©ãƒ¼: ' + text);
        }
    } catch (error) { 
        console.error(error);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message); 
    }
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸé¸æŠçŠ¶æ…‹ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
document.addEventListener('DOMContentLoaded', function() {
    updateBuyMethod();
});
</script>
</body>
</html>
